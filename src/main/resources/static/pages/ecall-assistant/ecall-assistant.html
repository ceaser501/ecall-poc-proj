<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Reception - E-Call Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, rgb(248, 250, 252) 0%, rgb(226, 232, 240) 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid rgb(226, 232, 240);
        }

        .header-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-icon {
            background: linear-gradient(135deg, rgb(239, 68, 68) 0%, rgb(220, 38, 38) 100%);
            padding: 0.625rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon svg {
            width: 1.25rem;
            height: 1.25rem;
            color: white;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: rgb(15, 23, 42);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 0.5rem;
            height: 0.5rem;
            background: rgb(148, 163, 184);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.active {
            background: rgb(34, 197, 94);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            color: rgb(71, 85, 105);
        }

        .status-time {
            color: rgb(15, 23, 42);
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid rgb(226, 232, 240);
            border-radius: 0.375rem;
            background: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgb(248, 250, 252);
            border-color: rgb(203, 213, 225);
        }

        .btn.active {
            background: rgb(59, 130, 246);
            border-color: rgb(59, 130, 246);
            color: white;
        }

        .btn.active:hover {
            background: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
        }

        .btn-primary {
            background: rgb(59, 130, 246);
            border-color: rgb(59, 130, 246);
            color: white;
        }

        .btn-primary:hover {
            background: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
        }

        .btn-icon {
            width: 2rem;
            height: 2rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn svg {
            width: 1rem;
            height: 1rem;
        }

        .header-logout-btn {
            background: #1e293b;
            color: white;
            padding: 0.375rem 0.625rem;
            border: 1px solid #1e293b;
            border-radius: 0.375rem;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            height: 2rem;
            display: inline-flex;
            align-items: center;
        }

        .header-logout-btn:hover {
            background: #0f172a;
            border-color: #0f172a;
        }

        /* Main Content */
        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: minmax(280px, 1fr) minmax(600px, 2fr) minmax(280px, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1400px) {
            .grid-container {
                grid-template-columns: 1fr;
            }

            .left-sidebar, .right-sidebar {
                display: none;
            }
        }

        .panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgb(226, 232, 240);
        }

        .panel-header {
            padding: 1.25rem;
            border-bottom: 1px solid rgb(226, 232, 240);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: rgb(15, 23, 42);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-body {
            padding: 1.25rem;
        }

        /* Left Sidebar - Caller Info */
        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgb(51, 65, 85);
            margin-bottom: 0.375rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid rgb(226, 232, 240);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: white;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: rgb(59, 130, 246);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:read-only {
            background: rgb(248, 250, 252);
        }

        .btn-update {
            width: 100%;
            background: rgb(71, 85, 105);
            border-color: rgb(71, 85, 105);
            color: white;
            margin-top: 0.75rem;
        }

        .btn-update:hover {
            background: rgb(51, 65, 85);
            border-color: rgb(51, 65, 85);
        }

        .divider {
            margin: 1.25rem 0;
            padding-top: 1.25rem;
            border-top: 1px solid rgb(226, 232, 240);
        }

        .btn-checklist {
            width: 100%;
            justify-content: center;
        }

        /* Center Panel - Transcript */
        .transcript-panel {
            height: 800px;
            display: flex;
            flex-direction: column;
        }

        .transcript-header-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgb(71, 85, 105);
            font-size: 0.875rem;
        }

        .transcript-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid;
        }

        .message-operator {
            background: rgb(236, 253, 245);
            border-color: rgb(167, 243, 208);
        }

        .message-caller {
            background: rgb(239, 246, 255);
            border-color: rgb(191, 219, 254);
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sender-avatar {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .operator-avatar {
            background: rgb(5, 150, 105);
        }

        .caller-avatar {
            background: rgb(37, 99, 235);
        }

        .sender-name {
            font-weight: 600;
            color: rgb(15, 23, 42);
        }

        .message-time {
            color: rgb(100, 116, 139);
            font-size: 0.875rem;
        }

        .message-text {
            color: rgb(51, 65, 85);
            line-height: 1.5;
            margin-left: 2rem;
        }

        .transcript-footer {
            border-top: 1px solid rgb(226, 232, 240);
            padding: 0.75rem;
            background: rgb(248, 250, 252);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .recording-dot {
            width: 0.5rem;
            height: 0.5rem;
            background: rgb(239, 68, 68);
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .recording-text {
            color: rgb(71, 85, 105);
            font-size: 0.875rem;
        }

        /* Right Sidebar */
        .operator-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .operator-avatar-lg {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: rgb(226, 232, 240);
            overflow: hidden;
            flex-shrink: 0;
        }

        .operator-avatar-lg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .operator-details {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .operator-name {
            font-weight: 600;
            color: rgb(15, 23, 42);
        }

        .operator-dept {
            color: rgb(71, 85, 105);
            font-size: 0.875rem;
        }

        .operator-exp {
            color: rgb(100, 116, 139);
            font-size: 0.875rem;
        }

        .manual-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .manual-item {
            background: rgb(241, 245, 249);
            padding: 0.625rem;
            border-radius: 0.5rem;
            color: rgb(51, 65, 85);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .manual-item:hover {
            background: rgb(226, 232, 240);
        }

        .timeline-list {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: rgb(51, 65, 85);
            font-size: 0.875rem;
        }

        .timeline-time {
            color: rgb(100, 116, 139);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgb(226, 232, 240);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: rgb(15, 23, 42);
        }

        .modal-desc {
            margin-top: 0.5rem;
            color: rgb(71, 85, 105);
            font-size: 0.875rem;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: calc(90vh - 200px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgb(226, 232, 240);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: rgb(100, 116, 139);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: rgb(15, 23, 42);
        }

        /* Checklist */
        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgb(248, 250, 252);
            border-radius: 0.5rem;
        }

        .checklist-question {
            color: rgb(51, 65, 85);
            flex: 1;
        }

        .checklist-buttons {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .btn-yes, .btn-no {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            border: 1px solid;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s;
        }

        .btn-yes {
            background: white;
            border-color: rgb(226, 232, 240);
            color: rgb(71, 85, 105);
        }

        .btn-yes.active {
            background: rgb(34, 197, 94);
            border-color: rgb(34, 197, 94);
            color: white;
        }

        .btn-no {
            background: white;
            border-color: rgb(226, 232, 240);
            color: rgb(71, 85, 105);
        }

        .btn-no.active {
            background: rgb(239, 68, 68);
            border-color: rgb(239, 68, 68);
            color: white;
        }

        /* Upload Modal */
        .upload-area {
            border: 2px dashed rgb(203, 213, 225);
            border-radius: 0.5rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: rgb(59, 130, 246);
        }

        .upload-icon {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.75rem;
            color: rgb(148, 163, 184);
        }

        .upload-text {
            color: rgb(51, 65, 85);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .upload-subtext {
            color: rgb(100, 116, 139);
            font-size: 0.875rem;
        }

        .file-input {
            display: none;
        }

        .uploaded-file {
            background: rgb(239, 246, 255);
            border: 1px solid rgb(191, 219, 254);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-info-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-icon {
            color: rgb(37, 99, 235);
        }

        .file-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .file-name {
            color: rgb(15, 23, 42);
            font-weight: 500;
        }

        .file-size {
            color: rgb(100, 116, 139);
            font-size: 0.875rem;
        }

        .remove-file-btn {
            background: none;
            border: none;
            color: rgb(71, 85, 105);
            cursor: pointer;
            padding: 0.25rem;
        }

        .remove-file-btn:hover {
            color: rgb(15, 23, 42);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 600px;
        }

        .empty-state.hidden {
            display: none;
        }

        .empty-state-content {
            text-align: center;
            max-width: 400px;
        }

        .empty-state-icon-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
        }

        .empty-state-icon {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: rgb(248, 250, 252);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: rgb(148, 163, 184);
        }

        .empty-state-pulse {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 24px;
            height: 24px;
            background: rgb(203, 213, 225);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s ease-in-out infinite;
        }

        .empty-state-pulse::after {
            content: '';
            width: 12px;
            height: 12px;
            background: rgb(148, 163, 184);
            border-radius: 50%;
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: rgb(15, 23, 42);
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            color: rgb(100, 116, 139);
            margin-bottom: 1.5rem;
        }

        .empty-state-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgb(248, 250, 252);
            border-radius: 9999px;
        }

        .empty-state-badge-dot {
            width: 8px;
            height: 8px;
            background: rgb(148, 163, 184);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .empty-state-badge span {
            color: rgb(100, 116, 139);
            font-size: 0.875rem;
        }

        .checklist-pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: rgb(239, 68, 68);
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .btn-checklist.has-checklist {
            background: rgb(254, 242, 242);
            border-color: rgb(239, 68, 68);
            color: rgb(220, 38, 38);
            font-weight: 600;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .btn-checklist.has-checklist:hover {
            background: rgb(254, 226, 226);
            border-color: rgb(220, 38, 38);
            color: rgb(185, 28, 28);
        }

        .checklist-required-badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.125rem 0.5rem;
            font-size: 0.625rem;
            font-weight: 700;
            background: rgb(239, 68, 68);
            color: white;
            border-radius: 9999px;
            letter-spacing: 0.05em;
        }

        /* Checklist completed state */
        .btn-checklist.checklist-completed {
            background: rgb(240, 253, 244);
            border-color: rgb(34, 197, 94);
            color: rgb(22, 163, 74);
            font-weight: 600;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
            cursor: not-allowed;
            opacity: 0.9;
        }

        .btn-checklist.checklist-completed:hover {
            background: rgb(240, 253, 244);
            border-color: rgb(34, 197, 94);
            color: rgb(22, 163, 74);
        }

        .btn-checklist.checklist-completed svg {
            margin-right: 0.5rem;
        }

        .btn-manual-update {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: rgb(59, 130, 246);
            border: 1px solid rgb(59, 130, 246);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .btn-manual-update:hover {
            background: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
        }

        .btn-manual-update:active {
            background: rgb(29, 78, 216);
            transform: scale(0.98);
        }

        .btn-manual-update svg {
            flex-shrink: 0;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 5rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            min-width: 320px;
            max-width: 480px;
            padding: 1rem 1.25rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: rgb(34, 197, 94);
        }

        .toast.error {
            border-left-color: rgb(239, 68, 68);
        }

        .toast.warning {
            border-left-color: rgb(251, 146, 60);
        }

        .toast.info {
            border-left-color: rgb(59, 130, 246);
        }

        .toast-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
        }

        .toast.success .toast-icon {
            color: rgb(34, 197, 94);
        }

        .toast.error .toast-icon {
            color: rgb(239, 68, 68);
        }

        .toast.warning .toast-icon {
            color: rgb(251, 146, 60);
        }

        .toast.info .toast-icon {
            color: rgb(59, 130, 246);
        }

        .toast-content {
            flex: 1;
            font-size: 0.875rem;
            line-height: 1.5;
            color: rgb(31, 41, 55);
        }

        .toast-close {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            cursor: pointer;
            color: rgb(107, 114, 128);
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: rgb(31, 41, 55);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast.slide-out {
            animation: slideOut 0.3s ease-in forwards;
        }

        /* Incoming Call Notification - Modern Design */
        .incoming-call-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 320px;
            z-index: 10001;
            display: none;
        }

        .incoming-call-notification.show {
            display: block;
            animation: slideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .incoming-call-glow {
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, #60a5fa, #818cf8);
            border-radius: 1rem;
            filter: blur(40px);
            opacity: 0.3;
            animation: pulse 2s ease-in-out infinite;
        }

        .incoming-call-card {
            position: relative;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .incoming-call-header {
            background: linear-gradient(to bottom right, #334155, #1e293b, #0f172a);
            padding: 1.5rem;
            padding-bottom: 2rem;
            position: relative;
        }

        .incoming-call-icon-wrapper {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .incoming-call-icon-wrapper svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .incoming-call-header-content {
            text-align: center;
        }

        .incoming-call-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .incoming-call-status-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .incoming-call-status-text {
            color: #f87171; /* red-400 */
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.875rem; /* Increased from 0.75rem */
            font-weight: 600; /* Increased from 500 */
        }

        .incoming-call-number {
            color: white;
            font-size: 1.5rem;
            letter-spacing: 0.05em;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .incoming-call-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
        }

        .incoming-call-actions {
            padding: 1rem;
            background: #f9fafb;
            display: flex;
            gap: 0.75rem;
        }

        .incoming-call-btn {
            flex: 1;
            height: 48px;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .incoming-call-btn svg {
            width: 20px;
            height: 20px;
        }

        .incoming-call-btn.decline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .incoming-call-btn.decline:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .incoming-call-btn.accept {
            background: linear-gradient(to right, #3b82f6, #6366f1);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }

        .incoming-call-btn.accept:hover {
            background: linear-gradient(to right, #2563eb, #4f46e5);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4);
        }

        .incoming-call-border-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, transparent, white, transparent);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Incoming Call Notification -->
    <div class="incoming-call-notification" id="incomingCallNotification">
        <div class="incoming-call-glow"></div>
        <div class="incoming-call-card">
            <div class="incoming-call-header">
                <div class="incoming-call-icon-wrapper">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="16 2 16 8 22 8"></polyline>
                        <line x1="22" y1="2" x2="16" y2="8"></line>
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                </div>
                <div class="incoming-call-header-content">
                    <div class="incoming-call-status">
                        <div class="incoming-call-status-dot"></div>
                        <div class="incoming-call-status-text">Emergency Call</div>
                    </div>
                    <div class="incoming-call-number" id="incomingCallNumber">010-1234-5678</div>
                    <div class="incoming-call-label">Incoming Emergency Report</div>
                </div>
            </div>
            <div class="incoming-call-actions">
                <button class="incoming-call-btn decline" onclick="declineCall()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Decline
                </button>
                <button class="incoming-call-btn accept" onclick="acceptCall()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Accept
                </button>
            </div>
            <div class="incoming-call-border-top"></div>
        </div>
    </div>

    <!-- Hidden ringtone audio -->
    <audio id="ringtoneAudio" style="display:none;">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- Header -->
    <div class="header">
        <div class="header-container">
            <div class="header-left">
                <div class="header-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                </div>
                <h1 class="header-title">Report Reception â€” ECA103</h1>
            </div>

            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="status-text">Standby</span>
                    <span class="status-time" id="callTimer">00:00</span>
                </div>
                <button class="btn btn-icon" onclick="window.location.href='ecall-intro.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </button>
                <button class="btn btn-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                </button>
                <button class="header-logout-btn" onclick="logout()">
                    Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="grid-container">
            <!-- Left Sidebar -->
            <div class="left-sidebar">
                <!-- Caller Information Panel -->
                <div class="panel" style="margin-bottom: 1.25rem;">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            Caller Information
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label class="form-label">Caller Number</label>
                            <input type="text" class="form-input" id="callerNumber" value="" placeholder="Waiting for call..." readonly>
                        </div>

                        <!-- Hidden: Caller Name -->
                        <!-- <div class="form-group">
                            <label class="form-label">Caller Name</label>
                            <input type="text" class="form-input" value="Minsu Kim">
                        </div> -->

                        <div class="form-group">
                            <label class="form-label">Incident Location</label>
                            <input type="text" class="form-input" id="incidentLocation" value="" placeholder="AI analyzing...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Incident Type</label>
                            <select class="form-input" id="incidentType" onchange="updateChecklist(false)">
                                <option value="">AI analyzing...</option>
                                <option value="disaster">Disaster</option>
                                <option value="medical">Medical</option>
                                <option value="crime">Crime</option>
                                <option value="traffic">Traffic</option>
                                <option value="rescue">Rescue</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Severity Level</label>
                            <select class="form-input" id="severityLevel">
                                <option value="">AI analyzing...</option>
                                <option value="1">Level 1 - Minimal</option>
                                <option value="2">Level 2 - Low</option>
                                <option value="3">Level 3 - Moderate</option>
                                <option value="4">Level 4 - High</option>
                                <option value="5">Level 5 - Critical</option>
                            </select>
                        </div>

                        <button class="btn btn-manual-update" onclick="updateIncidentInfo()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            Manual Update
                        </button>

                        <div class="divider">
                            <button class="btn btn-checklist" id="viewChecklistBtn" onclick="showChecklistModal()">
                                <span class="checklist-pulse-dot" id="checklistPulseDot" style="display: none;"></span>
                                View Checklist
                                <span class="checklist-required-badge" id="checklistRequiredBadge" style="display: none;">REQUIRED</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <div class="panel transcript-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">Live Transcript</h2>
                        <div class="transcript-header-info">
                            <span id="aiConfidence">AI Confidence: 0%</span>
                            <button class="btn" id="playBtn" onclick="playAudio()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                Play
                            </button>
                            <button class="btn" id="speakerBtn" onclick="toggleSpeaker()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                                Speaker
                            </button>
                        </div>
                    </div>

                    <div class="transcript-messages" id="transcriptMessages">
                        <!-- Empty State - Waiting for Call -->
                        <div class="empty-state" id="emptyState">
                            <div class="empty-state-content">
                                <div class="empty-state-icon-wrapper">
                                    <div class="empty-state-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                    </div>
                                    <div class="empty-state-pulse"></div>
                                </div>
                                <h3 class="empty-state-title">Waiting for Incoming Call</h3>
                                <p class="empty-state-description">The system is ready to receive emergency calls.</p>
                                <div class="empty-state-badge">
                                    <div class="empty-state-badge-dot"></div>
                                    <span>Standby Mode</span>
                                </div>
                            </div>
                        </div>
                        <!-- Messages will be added here dynamically -->
                    </div>

                    <div class="transcript-footer">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="recording-dot"></div>
                            <span class="recording-text" id="recordingText">System ready - Waiting for call...</span>
                        </div>
                        <!-- Upload Audio File Button - Hidden for simulation mode
                        <button class="btn btn-primary" onclick="showUploadModal()" style="padding: 0.375rem 0.75rem; font-size: 0.8125rem; height: auto;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3-3 3 3"/></svg>
                            Upload Audio File
                        </button>
                        -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="right-sidebar">
                <!-- Operator Info -->
                <div class="panel" style="margin-bottom: 1.25rem;">
                    <div class="panel-header">
                        <h2 class="panel-title">Operator Information</h2>
                    </div>
                    <div class="panel-body">
                        <div class="operator-info">
                            <div style="position: relative; width: 64px; height: 64px;">
                                <div class="operator-avatar-lg">
                                    <img id="operatorAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect fill='%23e2e8f0' width='64' height='64'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='%2364748b'%3EJP%3C/text%3E%3C/svg%3E" alt="Operator">
                                </div>
                                <label for="photoUpload" style="position: absolute; bottom: -4px; right: -4px; background: #2563eb; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">+</label>
                                <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                            </div>
                            <div class="operator-details">
                                <p id="operatorName" class="operator-name">Jihyun Park</p>
                                <p id="operatorDept" class="operator-dept">Emergency Center</p>
                                <p id="operatorExp" class="operator-exp">3 years exp.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Response Manual -->
                <div class="panel" style="margin-bottom: 1.25rem;">
                    <div class="panel-header">
                        <h2 class="panel-title">Response Manual</h2>
                    </div>
                    <div class="panel-body">
                        <div class="manual-list">
                            <div class="manual-item">CPR Procedure</div>
                            <div class="manual-item">Bleeding Control</div>
                            <div class="manual-item">Shock Management</div>
                            <div class="manual-item">Airway Support</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Timeline
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="timeline-list">
                            <div class="timeline-item">
                                <span>Call Started</span>
                                <span class="timeline-time">--:--:--</span>
                            </div>
                            <div class="timeline-item">
                                <span>Location Confirmed</span>
                                <span class="timeline-time">--:--:--</span>
                            </div>
                            <div class="timeline-item">
                                <span>Call Ended</span>
                                <span class="timeline-time">--:--:--</span>
                            </div>
                            <div class="timeline-item">
                                <span>Elapsed Time</span>
                                <span class="timeline-time">00:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checklist Modal -->
    <div id="checklistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeChecklistModal()">&times;</button>
                <h2 class="modal-title">Incident Type Checklist</h2>
                <p class="modal-desc" id="checklistDesc">Questions to assess the emergency situation.</p>
            </div>
            <div class="modal-body">
                <div class="checklist-items" id="checklistItems">
                    <!-- Dynamically generated -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeChecklistModal()">Close</button>
                <button class="btn btn-primary" onclick="saveChecklist()">Save Checklist</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
                <h2 class="modal-title">Upload Audio File</h2>
                <p class="modal-desc">Upload an MP3 audio file for transcription and analysis.</p>
            </div>
            <div class="modal-body">
                <div class="upload-area" onclick="document.getElementById('audioFile').click()">
                    <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3-3 3 3"/></svg>
                    <div class="upload-text">Click to upload or drag and drop</div>
                    <div class="upload-subtext">MP3 files only</div>
                </div>
                <input type="file" id="audioFile" class="file-input" accept=".mp3,audio/mp3,audio/mpeg" onchange="handleFileSelect(event)">
                <div id="uploadedFileInfo"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="uploadBtn" disabled onclick="uploadFile()">Upload</button>
            </div>
        </div>
    </div>

    <script>
        // Toast notification system
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            // Icon based on type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
                    break;
                case 'error':
                    icon = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
                    break;
                case 'warning':
                    icon = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
                    break;
                case 'info':
                default:
                    icon = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>';
            }

            toast.innerHTML = `
                ${icon}
                <div class="toast-content">${message}</div>
                <svg class="toast-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            `;

            // Add close button functionality
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                removeToast(toast);
            });

            container.appendChild(toast);

            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toast);
                }, duration);
            }
        }

        function removeToast(toast) {
            toast.classList.add('slide-out');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Load operator information from session
        document.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(sessionStorage.getItem('user'));

            if (user) {
                // Update operator name
                const operatorNameEl = document.getElementById('operatorName');
                if (operatorNameEl) {
                    operatorNameEl.textContent = user.name || 'Unknown';
                }

                // Update operator department
                const operatorDeptEl = document.getElementById('operatorDept');
                if (operatorDeptEl) {
                    operatorDeptEl.textContent = user.organizationName || 'N/A';
                }

                // Calculate years of experience from join_date
                const operatorExpEl = document.getElementById('operatorExp');
                if (operatorExpEl && user.joinDate) {
                    // Parse date string (yyyy-MM-dd) without timezone issues
                    const joinDateStr = user.joinDate.split('T')[0]; // Remove time part if exists
                    const [year, month, day] = joinDateStr.split('-').map(Number);
                    const joinDate = new Date(year, month - 1, day); // month is 0-indexed

                    const today = new Date();
                    const yearsDiff = today.getFullYear() - joinDate.getFullYear();
                    const monthsDiff = today.getMonth() - joinDate.getMonth();
                    const daysDiff = today.getDate() - joinDate.getDate();

                    // Adjust if birthday hasn't occurred this year
                    let diffYears = yearsDiff;
                    if (monthsDiff < 0 || (monthsDiff === 0 && daysDiff < 0)) {
                        diffYears--;
                    }

                    operatorExpEl.textContent = `${diffYears} year${diffYears !== 1 ? 's' : ''} exp.`;
                }

                // Update avatar - show photo if available, otherwise show initials
                const operatorAvatarEl = document.getElementById('operatorAvatar');
                if (operatorAvatarEl) {
                    if (user.photoUrl) {
                        operatorAvatarEl.src = user.photoUrl;
                    } else if (user.name) {
                        const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        const avatarSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect fill='%23e2e8f0' width='64' height='64'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='%2364748b'%3E${initials}%3C/text%3E%3C/svg%3E`;
                        operatorAvatarEl.src = avatarSvg;
                    }
                }
            }
        });

        // Handle photo upload
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const user = JSON.parse(sessionStorage.getItem('user'));
            if (!user || !user.id) {
                showToast('User not logged in', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('operatorId', user.id);

            try {
                const response = await fetch('/api/auth/upload-photo', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update avatar immediately
                    const operatorAvatarEl = document.getElementById('operatorAvatar');
                    if (operatorAvatarEl) {
                        operatorAvatarEl.src = result.fileUrl;
                    }

                    // Update session storage
                    user.photoUrl = result.fileUrl;
                    sessionStorage.setItem('user', JSON.stringify(user));

                    showToast('Photo uploaded successfully!', 'success');
                } else {
                    showToast('Upload failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                showToast('Upload failed. Please try again.', 'error');
            }
        }

        // Checklist data
        const checklistData = {
            disaster: [
                "Are you at the location now?",
                "Are you in a safe place?",
                "Is there a fire or building collapse?",
                "Is the fire or damage spreading?",
                "Are you injured?",
                "Is anyone trapped or in immediate danger?",
                "Do you smell gas or see hazardous materials?"
            ],
            medical: [
                "Are you with the patient now?",
                "Is the patient awake?",
                "Is the patient breathing normally?",
                "Is the patient bleeding badly?",
                "Is the patient having chest pain?",
                "Did the patient collapse suddenly?",
                "Does the patient have any known medical conditions?",
                "What is the patient's age and sex?"
            ],
            crime: [
                "Are you safe right now?",
                "Is the crime happening now?",
                "Does the suspect have a weapon?",
                "Is the suspect still at the location?",
                "Is anyone injured?",
                "Where is the suspect now? Did they flee?",
                "How many suspects are there?",
                "Are there other victims? Are they conscious or bleeding?"
            ],
            traffic: [
                "Are you at the accident scene?",
                "Is anyone injured?",
                "(If injured) Is the patient awake and breathing?",
                "Is anyone trapped in a vehicle?",
                "Is any vehicle on fire?",
                "Is any vehicle leaking fuel?",
                "Does this involve more than one vehicle?",
                "Is the accident blocking traffic?"
            ],
            rescue: [
                "Is someone trapped, isolated, or in the water?",
                "Is the person conscious?",
                "Is the person injured?",
                "Are you able to talk to them?",
                "Is the situation getting worse?",
                "Is there only one person needing rescue?",
                "If no, how many people?",
                "Are there any obstacles blocking the access route?"
            ],
            other: [
                "Is this a life-threatening or urgent situation?",
                "Is this related to a crime, fire, or medical emergency?",
                "Is this a simple noise complaint or civil issue?",
                "Do you just need advice or information?",
                "Have you reported this issue before?",
                "Is an officer (or firefighter) response necessary?",
                "Is there a risk of re-occurrence or conflict?",
                "When did this happen?"
            ]
        };

        const checklistDescriptions = {
            disaster: "Facility/environment risk: fire, explosion, smoke, natural disaster.",
            medical: "Immediate medical care required: cardiac arrest, unconscious, severe bleeding.",
            crime: "Violent offenses threatening life/body.",
            traffic: "Vehicle-related incidents.",
            rescue: "Physical rescue required: trapped, buried, water, high-rise isolation.",
            other: "Non-urgent, misreport, general inquiries."
        };

        let currentChecklist = {};
        let selectedFile = null;
        let audioElement = null; // For audio playback
        let transcriptSegments = [];
        let isPlaying = false;
        let callStartTime = null;
        let timerInterval = null;
        let displayedSegmentIndexes = new Set(); // Track which segments have been displayed
        let accumulatedTranscript = ''; // Accumulated transcript for AI analysis
        let aiLocationExtractionInProgress = false; // Prevent concurrent AI calls
        let aiIncidentClassificationInProgress = false; // Prevent concurrent AI classification calls
        let currentEmergencyId = null; // Store emergency ID for checklist saving
        let currentCallerId = null; // Store caller ID for checklist saving
        let detectedLanguage = null; // Store detected language from upload
        let mediaAssetId = null; // Store media asset ID from upload
        let callEndTime = null; // Store call end time for database
        let checklistSaved = false; // Track if checklist has been saved

        // Timer
        let seconds = 0;
        function startTimer() {
            if (timerInterval) return; // Already running
            // Update timer based on audio currentTime
            timerInterval = setInterval(() => {
                if (audioElement) {
                    seconds = Math.floor(audioElement.currentTime);
                } else {
                    seconds++;
                }
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                const timeStr = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                document.getElementById('callTimer').textContent = timeStr;

                // Update elapsed time in timeline
                const elapsedTimeEl = document.querySelector('.timeline-list .timeline-item:nth-child(4) .timeline-time');
                if (elapsedTimeEl) {
                    elapsedTimeEl.textContent = timeStr;
                }
            }, 100); // Update more frequently for smoother display
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Checklist functions
        function showChecklistModal(autoOpen = false) {
            // Don't open if checklist is already saved
            if (checklistSaved) {
                return;
            }

            const type = document.getElementById('incidentType').value;
            updateChecklist(autoOpen);
            document.getElementById('checklistModal').style.display = 'block';

            // Temporarily hide pulse/required badge while modal is open
            const pulseDot = document.getElementById('checklistPulseDot');
            const requiredBadge = document.getElementById('checklistRequiredBadge');
            if (pulseDot) {
                pulseDot.style.display = 'none';
            }
            if (requiredBadge) {
                requiredBadge.style.display = 'none';
            }
        }

        function closeChecklistModal() {
            document.getElementById('checklistModal').style.display = 'none';
            // Update button state when modal is closed
            updateChecklistButtonState();
        }

        async function saveChecklist() {
            // Check if transcript is in progress or completed
            if (!isPlaying && !currentEmergencyId) {
                showToast('Cannot save checklist: No emergency call in progress. Please upload an audio file first.', 'warning');
                return;
            }

            // Check if we have an emergency ID
            if (!currentEmergencyId) {
                showToast('Cannot save checklist: Emergency record is being created. Please wait a moment and try again.', 'warning');
                return;
            }

            // Check if we have a caller ID
            if (!currentCallerId) {
                showToast('Cannot save checklist: Caller information not found.', 'warning');
                return;
            }

            // Get operator ID from session
            const user = JSON.parse(sessionStorage.getItem('user'));
            const operatorId = user ? user.id : null;

            if (!operatorId) {
                showToast('Cannot save checklist: Operator not logged in.', 'warning');
                return;
            }

            // Check if any responses exist
            const type = document.getElementById('incidentType').value;
            const questions = checklistData[type];

            if (!questions || questions.length === 0) {
                showToast('No checklist to save. Please select an incident type first.', 'warning');
                return;
            }

            // Collect all checklist responses
            const responses = [];
            questions.forEach((question, index) => {
                const answer = currentChecklist[index];
                if (answer !== undefined) {
                    responses.push({
                        question: question,
                        answer: answer ? 'YES' : 'NO'
                    });
                }
            });

            if (responses.length === 0) {
                showToast('Please answer at least one question before saving.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/auth/save-checklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emergencyCallId: currentEmergencyId,
                        callerId: currentCallerId,
                        operatorId: operatorId,
                        incidentType: type,
                        responses: responses
                    })
                });

                const result = await response.json();

                if (result.success) {
                    checklistSaved = true; // Mark checklist as saved
                    showToast('Checklist saved successfully!', 'success');
                    updateChecklistButtonState(); // Update button appearance
                    closeChecklistModal();
                } else {
                    showToast('Failed to save checklist: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving checklist:', error);
                showToast('Error saving checklist. Please try again.', 'error');
            }
        }

        function updateChecklistButtonState() {
            const type = document.getElementById('incidentType').value;
            const questions = checklistData[type];

            const viewChecklistBtn = document.getElementById('viewChecklistBtn');
            const pulseDot = document.getElementById('checklistPulseDot');
            const requiredBadge = document.getElementById('checklistRequiredBadge');
            const completedBadge = document.getElementById('checklistCompletedBadge');

            if (!viewChecklistBtn) return;

            // If checklist is saved, show completed state
            if (checklistSaved) {
                viewChecklistBtn.classList.remove('has-checklist');
                viewChecklistBtn.classList.add('checklist-completed');
                viewChecklistBtn.disabled = true;
                viewChecklistBtn.innerHTML = `
                    <span class="checklist-pulse-dot" id="checklistPulseDot" style="display: none;"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Response Complete!
                    <span class="checklist-required-badge" id="checklistRequiredBadge" style="display: none;">REQUIRED</span>
                `;
            }
            // If checklist is required but not saved yet
            else if (type && type !== '' && questions && questions.length > 0) {
                viewChecklistBtn.classList.add('has-checklist');
                viewChecklistBtn.classList.remove('checklist-completed');
                viewChecklistBtn.disabled = false;
                viewChecklistBtn.innerHTML = `
                    <span class="checklist-pulse-dot" id="checklistPulseDot" style="display: inline-block;"></span>
                    View Checklist
                    <span class="checklist-required-badge" id="checklistRequiredBadge" style="display: inline-block;">REQUIRED</span>
                `;
            }
            // No checklist required
            else {
                viewChecklistBtn.classList.remove('has-checklist');
                viewChecklistBtn.classList.remove('checklist-completed');
                viewChecklistBtn.disabled = false;
                viewChecklistBtn.innerHTML = `
                    <span class="checklist-pulse-dot" id="checklistPulseDot" style="display: none;"></span>
                    View Checklist
                    <span class="checklist-required-badge" id="checklistRequiredBadge" style="display: none;">REQUIRED</span>
                `;
            }
        }

        function updateChecklist(autoOpen = false) {
            const type = document.getElementById('incidentType').value;
            const questions = checklistData[type];
            const description = checklistDescriptions[type];

            // Update button state
            updateChecklistButtonState();

            // Auto-open modal when type becomes 'emergency' (only if this is auto-triggered and not saved yet)
            if (autoOpen && type === 'emergency' && questions && questions.length > 0 && !checklistSaved) {
                showChecklistModal(true);
            }

            // Update modal checklist
            if (!questions || questions.length === 0) {
                document.getElementById('checklistDesc').textContent = 'Please select an incident type to view checklist.';
                document.getElementById('checklistItems').innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">No checklist available. Please select an incident type from the left panel.</div>';
                currentChecklist = {};
                return;
            }

            document.getElementById('checklistDesc').textContent = description;

            const container = document.getElementById('checklistItems');
            container.innerHTML = '';

            questions.forEach((question, index) => {
                const item = document.createElement('div');
                item.className = 'checklist-item';
                item.innerHTML = `
                    <span class="checklist-question">${question}</span>
                    <div class="checklist-buttons">
                        <button class="btn-yes" onclick="toggleAnswer(${index}, true)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            Yes
                        </button>
                        <button class="btn-no" onclick="toggleAnswer(${index}, false)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            No
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });

            currentChecklist = {};
        }

        function toggleAnswer(index, answer) {
            const items = document.getElementById('checklistItems').children;
            const yesBtn = items[index].querySelector('.btn-yes');
            const noBtn = items[index].querySelector('.btn-no');

            if (currentChecklist[index] === answer) {
                currentChecklist[index] = null;
                yesBtn.classList.remove('active');
                noBtn.classList.remove('active');
            } else {
                currentChecklist[index] = answer;
                if (answer) {
                    yesBtn.classList.add('active');
                    noBtn.classList.remove('active');
                } else {
                    yesBtn.classList.remove('active');
                    noBtn.classList.add('active');
                }
            }
        }

        // Update incident information manually
        async function updateIncidentInfo() {
            // Check if we have an emergency ID
            if (!currentEmergencyId) {
                showToast('Cannot update: No emergency record found. Please upload an audio file first.', 'warning');
                return;
            }

            // Get current values
            const incidentLocation = document.getElementById('incidentLocation').value.trim();
            const incidentType = document.getElementById('incidentType').value;
            const severityLevel = document.getElementById('severityLevel').value;

            // Validate that at least one field has a value
            if (!incidentLocation && !incidentType && !severityLevel) {
                showToast('Please enter at least one field to update.', 'warning');
                return;
            }

            // Build update object
            const updates = {};
            if (incidentLocation) {
                updates.caller_location = incidentLocation;
            }
            if (incidentType && incidentType !== '') {
                updates.type = incidentType;
            }
            if (severityLevel && severityLevel !== '') {
                updates.risk_level = parseInt(severityLevel);
            }

            try {
                // Send update request to backend
                const response = await fetch(`/api/auth/emergency/${currentEmergencyId}/update`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    showToast('Incident information updated successfully!', 'success');
                    console.log('Updated fields:', updates);

                    // Update checklist if incident type changed
                    if (updates.type) {
                        updateChecklist(false);
                    }
                } else {
                    const error = await response.text();
                    showToast('Failed to update incident information: ' + error, 'error');
                }
            } catch (error) {
                console.error('Error updating incident information:', error);
                showToast('Error updating incident information. Please try again.', 'error');
            }
        }

        // Upload functions
        function showUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            selectedFile = null;
            document.getElementById('uploadedFileInfo').innerHTML = '';
            document.getElementById('uploadBtn').disabled = true;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                document.getElementById('uploadedFileInfo').innerHTML = `
                    <div class="uploaded-file">
                        <div class="file-info-wrapper">
                            <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${fileSize} MB</div>
                            </div>
                        </div>
                        <button class="remove-file-btn" onclick="removeFile()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                        </button>
                    </div>
                `;
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function removeFile() {
            selectedFile = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('uploadedFileInfo').innerHTML = '';
            document.getElementById('uploadBtn').disabled = true;
        }

        async function uploadFile() {
            if (!selectedFile) return;

            // Store file reference locally before upload
            const audioFile = selectedFile;

            try {
                // Show loading state
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').textContent = 'Processing...';

                // Get operator ID from session
                const user = JSON.parse(sessionStorage.getItem('user'));
                const operatorId = user ? user.id : null;

                // Get caller information from form (hardcoded for now)
                const callerPhoneNumber = '010-8734-2910';
                const callerName = 'Minsu Kim';

                // Create FormData
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('minSpeakers', '1');
                formData.append('maxSpeakers', '5');

                // Add caller and operator information
                if (callerPhoneNumber) {
                    formData.append('callerPhoneNumber', callerPhoneNumber);
                }
                if (callerName) {
                    formData.append('callerName', callerName);
                }
                if (operatorId) {
                    formData.append('operatorId', operatorId);
                }

                // Call Clova API
                const response = await fetch('/api/voice/upload/clova', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success && result.speakerSegments) {
                    transcriptSegments = result.speakerSegments;

                    // Store language if returned
                    if (result.language) {
                        detectedLanguage = result.language;
                        console.log('Detected language:', detectedLanguage);
                    }

                    // Store media asset ID if returned
                    if (result.mediaAssetId) {
                        mediaAssetId = result.mediaAssetId;
                        console.log('Media asset ID:', mediaAssetId);
                    }

                    closeUploadModal();

                    // Create audio element for playback
                    try {
                        const audioUrl = URL.createObjectURL(audioFile);
                        audioElement = new Audio(audioUrl);

                        // Reset displayed segments
                        displayedSegmentIndexes.clear();

                        // Sync transcript with audio playback
                        audioElement.addEventListener('timeupdate', () => {
                            syncTranscriptWithAudio();
                        });

                        // Auto-play audio and activate speaker button
                        audioElement.play();
                        const speakerBtn = document.getElementById('speakerBtn');
                        if (speakerBtn) {
                            speakerBtn.classList.add('active');
                        }

                        // Remove active class when audio ends
                        audioElement.addEventListener('ended', () => {
                            if (speakerBtn) {
                                speakerBtn.classList.remove('active');
                            }
                        });
                    } catch (audioError) {
                        console.error('Error creating audio element:', audioError);
                        // Audio playback will not be available, but transcript will still work
                    }

                    // Hide empty state
                    const emptyState = document.getElementById('emptyState');
                    if (emptyState) {
                        emptyState.classList.add('hidden');
                    }

                    // Reset timer
                    stopTimer();
                    seconds = 0;

                    // Initialize transcript display
                    initializeTranscriptDisplay();
                } else {
                    showToast('Failed to process audio file: ' + (result.error || result.message), 'error');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                showToast('Error uploading file. Please try again.', 'error');
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = 'Upload';
            }
        }

        function initializeTranscriptDisplay() {
            if (!transcriptSegments || transcriptSegments.length === 0) return;

            isPlaying = true;

            // Reset accumulated transcript and AI extraction state for new call
            accumulatedTranscript = '';
            aiLocationExtractionInProgress = false;
            aiIncidentClassificationInProgress = false;
            checklistSaved = false; // Reset checklist saved status for new call

            // Update status to "On Call"
            const statusTextEl = document.querySelector('.status-text');
            if (statusTextEl) {
                statusTextEl.textContent = 'On Call';
            }

            // Activate status dot
            const statusDot = document.querySelector('.status-dot');
            if (statusDot) {
                statusDot.classList.add('active');
            }

            // Update recording text
            const recordingTextEl = document.getElementById('recordingText');
            if (recordingTextEl) {
                recordingTextEl.textContent = 'Voice recognition active...';
            }

            // Start timer (now synced with actual audio)
            startTimer();

            // Update Call Started time
            callStartTime = new Date();
            const timeStr = formatTime(callStartTime);
            const callStartedEl = document.querySelector('.timeline-list .timeline-item:nth-child(1) .timeline-time');
            if (callStartedEl) {
                callStartedEl.textContent = timeStr;
            }

            // Create initial emergency record for checklist saving
            createInitialEmergency();
        }

        function syncTranscriptWithAudio() {
            if (!audioElement || !transcriptSegments || transcriptSegments.length === 0) return;

            const currentTime = audioElement.currentTime;
            const locationConfirmIndex = Math.floor(transcriptSegments.length * 0.3);

            // Find segments that should be displayed at current time
            transcriptSegments.forEach((segment, index) => {
                // Check if this segment should be displayed now and hasn't been displayed yet
                if (currentTime >= segment.startTime && !displayedSegmentIndexes.has(index)) {
                    displayedSegmentIndexes.add(index);
                    addMessageToTranscript(segment, index);

                    // Update AI Confidence (average of all displayed segments so far)
                    const displayedSegments = transcriptSegments.filter((_, i) => displayedSegmentIndexes.has(i));
                    updateAIConfidence(displayedSegments);

                    // Update Location Confirmed
                    if (index === locationConfirmIndex) {
                        const locationTime = new Date(callStartTime.getTime() + segment.startTime * 1000);
                        const locationTimeStr = formatTime(locationTime);
                        const locationEl = document.querySelector('.timeline-list .timeline-item:nth-child(2) .timeline-time');
                        if (locationEl) {
                            locationEl.textContent = locationTimeStr;
                        }
                    }

                    // Check if this is the last segment
                    if (index === transcriptSegments.length - 1) {
                        // Wait a bit then stop
                        setTimeout(() => {
                            stopTimer();
                            isPlaying = false;

                            // Update Call Ended time and store it for database
                            callEndTime = new Date(callStartTime.getTime() + segment.endTime * 1000);
                            const callEndTimeStr = formatTime(callEndTime);
                            const callEndedEl = document.querySelector('.timeline-list .timeline-item:nth-child(3) .timeline-time');
                            if (callEndedEl) {
                                callEndedEl.textContent = callEndTimeStr;
                            }

                            // Reset status to Call Ended
                            const statusTextEl = document.querySelector('.status-text');
                            if (statusTextEl) {
                                statusTextEl.textContent = 'Call Ended';
                            }

                            // Deactivate status dot
                            const statusDot = document.querySelector('.status-dot');
                            if (statusDot) {
                                statusDot.classList.remove('active');
                            }

                            // Update recording text
                            const recordingTextEl = document.getElementById('recordingText');
                            if (recordingTextEl) {
                                recordingTextEl.textContent = 'Call completed - System ready for next call';
                            }

                            // Complete emergency and save to database
                            completeEmergency();
                        }, 1000);
                    }
                }
            });
        }

        function addMessageToTranscript(segment, index) {
            const messagesContainer = document.querySelector('.transcript-messages');

            // Determine if speaker is operator (speakerId 0) or caller (speakerId 1+)
            const isOperator = segment.speakerId === 0;
            const messageClass = isOperator ? 'message-operator' : 'message-caller';
            const avatarClass = isOperator ? 'operator-avatar' : 'caller-avatar';
            const senderName = isOperator ? 'Operator' : 'Caller';
            const avatarLetter = isOperator ? 'O' : 'C';

            // Format time (HH:MM:SS) - apply 2x speed
            const time = new Date(callStartTime.getTime() + segment.startTime * 500);
            const timeStr = formatTime(time);

            // Normalize text for display (fix common speech recognition errors)
            const normalizedText = normalizeLocationText(segment.text);

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageClass}`;
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">
                        <div class="sender-avatar ${avatarClass}">${avatarLetter}</div>
                        <span class="sender-name">${senderName}</span>
                    </div>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-text">
                    ${normalizedText}
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            // Auto-scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Accumulate transcript for AI analysis (use normalized text)
            const speaker = isOperator ? 'Operator' : 'Caller';
            accumulatedTranscript += `${speaker}: ${normalizedText}\n`;

            // Analyze message content to extract incident information
            // Only analyze caller's messages (not operator's questions)
            if (!isOperator) {
                analyzeIncidentInfo(segment.text);
            } else {
                // Even for operator, extract location if mentioned
                extractLocation(segment.text);
            }
        }

        // AI-powered incident information extraction
        function analyzeIncidentInfo(text) {
            const lowerText = text.toLowerCase();

            // Skip if it's a question (operator asking)
            if (text.includes('?') || text.includes('emergency?') || text.includes("what's your emergency")) {
                // Still extract location even from questions
                extractLocation(text);
                return;
            }

            // Analyze incident type - prioritize specific types over generic "emergency"
            const incidentTypeEl = document.getElementById('incidentType');
            if (incidentTypeEl && incidentTypeEl.value === '') {
                // Priority 1: Crime (expanded keywords)
                if (lowerText.includes('crime') || lowerText.includes('ë²”ì£„') ||
                    lowerText.includes('knife') || lowerText.includes('ì¹¼') ||
                    lowerText.includes('gun') || lowerText.includes('ì´') ||
                    lowerText.includes('weapon') || lowerText.includes('ë¬´ê¸°') ||
                    lowerText.includes('chasing') || lowerText.includes('ì«“') || lowerText.includes('ë”°ë¼') ||
                    lowerText.includes('attack') || lowerText.includes('ê³µê²©') ||
                    lowerText.includes('threat') || lowerText.includes('ìœ„í˜‘') ||
                    lowerText.includes('robbery') || lowerText.includes('ê°•ë„') ||
                    lowerText.includes('assault') || lowerText.includes('í­í–‰') ||
                    lowerText.includes('steal') || lowerText.includes('ë„ë‘‘') || lowerText.includes('ì ˆë„') ||
                    lowerText.includes('kidnap') || lowerText.includes('ë‚©ì¹˜') ||
                    lowerText.includes('murder') || lowerText.includes('ì‚´ì¸') ||
                    lowerText.includes('stab') || lowerText.includes('ì°Œë¥´')) {
                    incidentTypeEl.value = 'crime';
                    updateChecklist(true);
                }
                // Priority 2: Disaster (fire, explosion, building collapse, natural disaster)
                else if (lowerText.includes('fire') || lowerText.includes('í™”ìž¬') ||
                         lowerText.includes('ë¶ˆì´') || lowerText.includes('ë¶ˆë‚˜') ||
                         lowerText.includes('smoke') || lowerText.includes('ì—°ê¸°') ||
                         lowerText.includes('burning') || lowerText.includes('íƒ€ê³ ') || lowerText.includes('ë¶ˆíƒ€') ||
                         lowerText.includes('flames') || lowerText.includes('í™”ì—¼') ||
                         lowerText.includes('explosion') || lowerText.includes('í­ë°œ') ||
                         lowerText.includes('collapse') || lowerText.includes('ë¶•ê´´') ||
                         lowerText.includes('earthquake') || lowerText.includes('ì§€ì§„')) {
                    incidentTypeEl.value = 'disaster';
                    updateChecklist(true);
                }
                // Priority 3: Medical (medical emergency, cardiac arrest, unconscious, severe bleeding)
                else if (lowerText.includes('cardiac arrest') || lowerText.includes('ì‹¬ì •ì§€') ||
                         lowerText.includes('unconscious') || lowerText.includes('ì˜ì‹') ||
                         lowerText.includes('bleeding') || lowerText.includes('í”¼') || lowerText.includes('ì¶œí˜ˆ') ||
                         lowerText.includes('chest pain') || lowerText.includes('ê°€ìŠ´') ||
                         lowerText.includes('breathing') || lowerText.includes('í˜¸í¡') ||
                         lowerText.includes('injured') || lowerText.includes('ë‹¤ì³¤') || lowerText.includes('ë¶€ìƒ') ||
                         lowerText.includes('hurt') || lowerText.includes('ì•„í”„') ||
                         lowerText.includes('fell') || lowerText.includes('ë–¨ì–´') ||
                         lowerText.includes('broken') || lowerText.includes('ê³¨ì ˆ')) {
                    incidentTypeEl.value = 'medical';
                    updateChecklist(true);
                }
                // Priority 4: Traffic (vehicle-related incidents)
                else if (lowerText.includes('accident') || lowerText.includes('ì‚¬ê³ ') ||
                         lowerText.includes('crash') || lowerText.includes('ì¶©ëŒ') ||
                         lowerText.includes('car') || lowerText.includes('ì°¨ëŸ‰') || lowerText.includes('êµí†µ') ||
                         lowerText.includes('hit') || lowerText.includes('ë¶€ë”ª') ||
                         lowerText.includes('vehicle') || lowerText.includes('ìžë™ì°¨')) {
                    incidentTypeEl.value = 'traffic';
                    updateChecklist(true);
                }
                // Priority 5: Rescue (trapped, buried, water, high-rise isolation)
                else if (lowerText.includes('trapped') || lowerText.includes('ê°‡') ||
                         lowerText.includes('buried') || lowerText.includes('ë§¤ëª°') ||
                         lowerText.includes('water') || lowerText.includes('ë¬¼') ||
                         lowerText.includes('drowning') || lowerText.includes('ìµìˆ˜') ||
                         lowerText.includes('isolated') || lowerText.includes('ê³ ë¦½')) {
                    incidentTypeEl.value = 'rescue';
                    updateChecklist(true);
                }
                // Priority 6: Other (non-urgent, general inquiries)
                else if ((lowerText.includes('ì‘ê¸‰') || lowerText.includes('ìœ„ê¸‰') || lowerText.includes('ìœ„í—˜') ||
                          lowerText.includes('ë„ì™€ì£¼ì„¸ìš”') || lowerText.includes('ì‚´ë ¤') ||
                          lowerText.includes('help me') || lowerText.includes('save me')) &&
                         !lowerText.includes('ë¬´ìŠ¨') && !lowerText.includes('ì–´ë–¤') && !lowerText.includes('what')) {
                    incidentTypeEl.value = 'other';
                    updateChecklist(true);
                }
            }

            // Analyze incident location
            extractLocation(text);

            // Analyze severity level based on keywords
            analyzeSeverityLevel(text, lowerText);

            // If incident type still not found by keywords, try AI classification
            if (incidentTypeEl && incidentTypeEl.value === '' && accumulatedTranscript.length > 50) {
                classifyIncidentTypeWithAI();
            }

            // Try AI-powered location extraction if accumulated transcript is sufficient
            if (accumulatedTranscript.length > 50) {
                extractLocationWithAI();
            }

            // Note: AI risk assessment disabled - keyword-based detection provides real-time updates
            // Periodically assess risk level with AI (every 100 characters of transcript)
            // if (accumulatedTranscript.length > 0 && accumulatedTranscript.length % 100 < 50) {
            //     assessRiskLevelWithAI();
            // }
        }

        // Analyze severity level based on keywords
        function analyzeSeverityLevel(text, lowerText) {
            const severityLevelEl = document.getElementById('severityLevel');
            if (!severityLevelEl) return;

            const currentLevel = severityLevelEl.value;

            // Level 1 - Critical: Life-threatening situations
            if (lowerText.includes('dying') || lowerText.includes('ì£½') ||
                lowerText.includes('can\'t breathe') || lowerText.includes('ìˆ¨ì„') || lowerText.includes('í˜¸í¡') ||
                lowerText.includes('cardiac arrest') || lowerText.includes('ì‹¬ì •ì§€') ||
                lowerText.includes('unconscious') || lowerText.includes('ì˜ì‹') ||
                lowerText.includes('severe bleeding') || lowerText.includes('ëŒ€ëŸ‰') || lowerText.includes('í”¼ê°€') ||
                lowerText.includes('not breathing') || lowerText.includes('í˜¸í¡ì•ˆ') ||
                lowerText.includes('chest pain') || lowerText.includes('ê°€ìŠ´í†µì¦') ||
                lowerText.includes('shooting') || lowerText.includes('ì´') ||
                lowerText.includes('stabbing') || lowerText.includes('ì¹¼') || lowerText.includes('ì°Œë¥´') ||
                lowerText.includes('fire spreading') || lowerText.includes('ë¶ˆë²ˆ') ||
                lowerText.includes('explosion') || lowerText.includes('í­ë°œ')) {
                // Only upgrade to level 1, never downgrade
                if (currentLevel === '' || parseInt(currentLevel) > 1) {
                    severityLevelEl.value = '1';
                    console.log('Severity upgraded to Level 1 - Critical');
                }
            }
            // Level 2 - High: Serious but not immediately life-threatening
            else if ((lowerText.includes('injured') || lowerText.includes('ë‹¤ì³¤') || lowerText.includes('ë¶€ìƒ') ||
                      lowerText.includes('bleeding') || lowerText.includes('í”¼') || lowerText.includes('ì¶œí˜ˆ') ||
                      lowerText.includes('broken bone') || lowerText.includes('ê³¨ì ˆ') ||
                      lowerText.includes('severe pain') || lowerText.includes('ì‹¬í•œí†µì¦') ||
                      lowerText.includes('trapped') || lowerText.includes('ê°‡') ||
                      lowerText.includes('multiple victims') || lowerText.includes('ì—¬ëŸ¬ëª…') ||
                      lowerText.includes('weapon') || lowerText.includes('ë¬´ê¸°') ||
                      lowerText.includes('assault') || lowerText.includes('í­í–‰')) &&
                     currentLevel !== '1') {
                // Upgrade to level 2 if current is lower
                if (currentLevel === '' || parseInt(currentLevel) > 2) {
                    severityLevelEl.value = '2';
                    console.log('Severity upgraded to Level 2 - High');
                }
            }
            // Level 3 - Moderate: Requires attention but not urgent
            else if ((lowerText.includes('hurt') || lowerText.includes('ì•„í”„') ||
                      lowerText.includes('accident') || lowerText.includes('ì‚¬ê³ ') ||
                      lowerText.includes('minor injury') || lowerText.includes('ê²½ìƒ') ||
                      lowerText.includes('fender bender') || lowerText.includes('ì ‘ì´‰ì‚¬ê³ ') ||
                      lowerText.includes('smoke') || lowerText.includes('ì—°ê¸°') ||
                      lowerText.includes('suspicious') || lowerText.includes('ìˆ˜ìƒ')) &&
                     currentLevel !== '1' && currentLevel !== '2') {
                // Upgrade to level 3 if current is lower
                if (currentLevel === '' || parseInt(currentLevel) > 3) {
                    severityLevelEl.value = '3';
                    console.log('Severity upgraded to Level 3 - Moderate');
                }
            }
            // Level 4 - Low: Non-urgent situations
            else if ((lowerText.includes('property damage') || lowerText.includes('ìž¬ì‚°í”¼í•´') ||
                      lowerText.includes('noise complaint') || lowerText.includes('ì†ŒìŒ') ||
                      lowerText.includes('parking') || lowerText.includes('ì£¼ì°¨') ||
                      lowerText.includes('minor theft') || lowerText.includes('ê²½ë¯¸')) &&
                     currentLevel !== '1' && currentLevel !== '2' && currentLevel !== '3') {
                // Upgrade to level 4 if current is lower
                if (currentLevel === '' || parseInt(currentLevel) > 4) {
                    severityLevelEl.value = '4';
                    console.log('Severity upgraded to Level 4 - Low');
                }
            }
            // Level 5 - Minimal: Information requests
            else if ((lowerText.includes('question') || lowerText.includes('ì§ˆë¬¸') ||
                      lowerText.includes('inquiry') || lowerText.includes('ë¬¸ì˜') ||
                      lowerText.includes('information') || lowerText.includes('ì •ë³´')) &&
                     currentLevel === '') {
                severityLevelEl.value = '5';
                console.log('Severity set to Level 5 - Minimal');
            }
        }

        // AI-powered risk level assessment (called periodically during conversation)
        let aiRiskAssessmentInProgress = false;
        let lastRiskAssessmentTranscriptLength = 0;

        async function assessRiskLevelWithAI() {
            // Avoid duplicate calls and only call if transcript has grown significantly
            if (aiRiskAssessmentInProgress ||
                accumulatedTranscript.length < 50 ||
                accumulatedTranscript.length - lastRiskAssessmentTranscriptLength < 100) {
                return;
            }

            try {
                aiRiskAssessmentInProgress = true;
                lastRiskAssessmentTranscriptLength = accumulatedTranscript.length;

                const response = await fetch('/api/openai/assess-risk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcript: accumulatedTranscript
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.level) {
                        const severityLevelEl = document.getElementById('severityLevel');
                        if (severityLevelEl) {
                            const currentLevel = severityLevelEl.value;
                            const newLevel = result.level.toString();

                            // Always update with AI assessment (AI is more accurate)
                            if (currentLevel !== newLevel) {
                                severityLevelEl.value = newLevel;
                                console.log(`AI Risk Assessment: Level ${newLevel} - ${result.reason}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('AI risk assessment failed:', error);
            } finally {
                aiRiskAssessmentInProgress = false;
            }
        }

        // AI-powered incident type classification using OpenAI
        async function classifyIncidentTypeWithAI() {
            // Check if type already found or AI classification already in progress
            const incidentTypeEl = document.getElementById('incidentType');
            if (!incidentTypeEl || incidentTypeEl.value || aiIncidentClassificationInProgress) {
                return;
            }

            try {
                aiIncidentClassificationInProgress = true;

                const response = await fetch('/api/auth/classify-incident', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcript: accumulatedTranscript
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success === 'true' && result.incidentType && result.incidentType.trim() !== '') {
                        // Only update if incident type field is still empty
                        if (!incidentTypeEl.value || incidentTypeEl.value === '') {
                            incidentTypeEl.value = result.incidentType;
                            updateChecklist(true);
                            console.log('AI classified incident type:', result.incidentType);
                        }
                    }
                }
            } catch (error) {
                console.error('Error calling AI incident classification:', error);
            } finally {
                // Allow next classification after 5 seconds
                setTimeout(() => {
                    aiIncidentClassificationInProgress = false;
                }, 5000);
            }
        }

        // AI-powered location extraction using OpenAI + Kakao Map API
        async function extractLocationWithAI() {
            // Check if location already found or AI extraction already in progress
            const locationEl = document.getElementById('incidentLocation');
            if (!locationEl || locationEl.value || aiLocationExtractionInProgress) {
                return;
            }

            try {
                aiLocationExtractionInProgress = true;

                const response = await fetch('/api/auth/extract-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcript: accumulatedTranscript
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success === 'true' && result.location && result.location.trim() !== '') {
                        // Only update if location field is still empty
                        if (!locationEl.value) {
                            locationEl.value = result.location;
                            console.log('AI extracted location:', result.location);
                        }
                    }
                }
            } catch (error) {
                console.error('Error calling AI location extraction:', error);
            } finally {
                // Allow next extraction after 5 seconds
                setTimeout(() => {
                    aiLocationExtractionInProgress = false;
                }, 5000);
            }
        }

        // Normalize location text to fix common speech recognition errors
        function normalizeLocationText(location) {
            if (!location) {
                return location;
            }

            let normalized = location;

            // Fix common Korean district name recognition errors
            // "ganggu" -> "Gangseo-gu"
            normalized = normalized.replace(/\bganggu\b/gi, 'Gangseo-gu');

            // Add more common corrections
            normalized = normalized.replace(/\bgangnam(?!-gu)\b/gi, 'Gangnam-gu');
            normalized = normalized.replace(/\bgangdong(?!-gu)\b/gi, 'Gangdong-gu');
            normalized = normalized.replace(/\bjongno(?!-gu)\b/gi, 'Jongno-gu');
            normalized = normalized.replace(/\bmapo(?!-gu)\b/gi, 'Mapo-gu');

            return normalized;
        }

        // Enhanced location extraction with API lookup
        async function extractLocation(text) {
            const locationEl = document.getElementById('incidentLocation');
            if (!locationEl || locationEl.value !== '') {
                return; // Already has a value
            }

            let extractedAddress = null;

            // Pattern 1: Full Korean address (ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ëŒ€ì¹˜ë™ 152)
            const fullAddressPattern = /([ê°€-íž£]+(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ì‹œ|ë„)\s*[ê°€-íž£]+êµ¬\s*[ê°€-íž£]+ë™\s*\d+[-\d]*)/g;
            let matches = text.match(fullAddressPattern);
            if (matches && matches.length > 0) {
                extractedAddress = matches[0].trim();
            }

            // Pattern 2: District + Neighborhood + Number (ê°•ë‚¨êµ¬ ëŒ€ì¹˜ë™ 152ë²ˆì§€)
            if (!extractedAddress) {
                const districtPattern = /([ê°€-íž£]+êµ¬\s*[ê°€-íž£]+ë™\s*\d+[-\d]*(?:ë²ˆì§€|ë²ˆ)?)/g;
                matches = text.match(districtPattern);
                if (matches && matches.length > 0) {
                    extractedAddress = matches[0].trim();
                }
            }

            // Pattern 3: Road address (í…Œí—¤ëž€ë¡œ 152, ê°•ë‚¨ëŒ€ë¡œ 123ê¸¸)
            if (!extractedAddress) {
                const roadAddressPattern = /([ê°€-íž£]+(?:ë¡œ|ëŒ€ë¡œ|ê¸¸)\s*\d+[-\d]*(?:ê¸¸)?)/g;
                matches = text.match(roadAddressPattern);
                if (matches && matches.length > 0) {
                    const roadMatch = matches[0];
                    const roadIndex = text.indexOf(roadMatch);
                    const beforeRoad = text.substring(Math.max(0, roadIndex - 20), roadIndex);
                    const districtMatch = beforeRoad.match(/([ê°€-íž£]+(?:êµ¬|ì‹œ))/);

                    if (districtMatch) {
                        extractedAddress = districtMatch[0] + ' ' + roadMatch.trim();
                    } else {
                        extractedAddress = roadMatch.trim();
                    }
                }
            }

            // Pattern 4: Building name + area (ë¡¯ë°íƒ€ì›Œ ì†¡íŒŒêµ¬, ì½”ì—‘ìŠ¤ ê°•ë‚¨êµ¬)
            if (!extractedAddress) {
                const buildingPattern = /([ê°€-íž£]+(?:íƒ€ì›Œ|ë¹Œë”©|ì„¼í„°|ì•„íŒŒíŠ¸|ë¹Œë¼)\s*[ê°€-íž£]+(?:êµ¬|ì‹œ))/g;
                matches = text.match(buildingPattern);
                if (matches && matches.length > 0) {
                    extractedAddress = matches[0].trim();
                }
            }

            // Pattern 5: Simple area mention (ê°•ë‚¨êµ¬ ëŒ€ì¹˜ë™)
            if (!extractedAddress) {
                const areaPattern = /([ê°€-íž£]+êµ¬\s*[ê°€-íž£]+ë™)/g;
                matches = text.match(areaPattern);
                if (matches && matches.length > 0) {
                    extractedAddress = matches[0].trim();
                }
            }

            // Pattern 6: City + district (ì„œìš¸ ê°•ë‚¨êµ¬)
            if (!extractedAddress) {
                const cityDistrictPattern = /([ê°€-íž£]+(?:ì‹œ|ë„)\s*[ê°€-íž£]+êµ¬)/g;
                matches = text.match(cityDistrictPattern);
                if (matches && matches.length > 0) {
                    extractedAddress = matches[0].trim();
                }
            }

            // Pattern 7: English address with number (152 Daechi-dong, Gangnam-gu)
            if (!extractedAddress) {
                const englishAddressPattern = /(\d+\s+[A-Za-z]+-[A-Za-z]+(?:,\s*[A-Za-z]+-[A-Za-z]+)+)/gi;
                matches = text.match(englishAddressPattern);
                if (matches && matches.length > 0) {
                    extractedAddress = matches[0].trim();
                }
            }

            // Pattern 8: English full address with street name (152 Main Street)
            if (!extractedAddress) {
                const englishFullPattern = /(\d+\s+[A-Za-z\s]+(?:Street|Road|Avenue|Blvd|Boulevard|Lane|Drive|Way|Court|Plaza)(?:,\s*[A-Za-z\s]+)?)/gi;
                matches = text.match(englishFullPattern);
                if (matches && matches.length > 0) {
                    extractedAddress = matches[0].trim();
                }
            }

            // Pattern 9: Location after specific indicators (I'm at Central Park)
            if (!extractedAddress) {
                // More specific patterns for location indicators
                const atPattern = /\b(?:I'm\s+at|at\s+the|near\s+the|near|at)\s+([A-Z][A-Za-z\s]+(?:Park|Station|Mall|Center|Building|Tower|Hospital|School|Airport|Plaza))/gi;
                matches = text.match(atPattern);
                if (matches && matches.length > 0) {
                    // Extract just the location name
                    const locationName = matches[0].replace(/\b(?:I'm\s+at|at\s+the|near\s+the|near|at)\s+/gi, '').trim();
                    if (locationName.length > 3) {
                        extractedAddress = locationName;
                    }
                }
            }

            // Validate extracted address
            if (extractedAddress) {
                // Normalize the extracted address (fix common speech recognition errors)
                extractedAddress = normalizeLocationText(extractedAddress);
                console.log('Normalized address:', extractedAddress);

                // Remove if too short or looks like regular text
                if (extractedAddress.length < 5) {
                    console.log('Address too short, ignoring:', extractedAddress);
                    return;
                }

                // Check if it contains common non-address words (filtering out false positives)
                const nonAddressWords = /\b(chasing|help|please|someone|knife|gun|scared|emergency|hurry|quick|come)\b/gi;
                if (nonAddressWords.test(extractedAddress)) {
                    console.log('Extracted text contains non-address words, ignoring:', extractedAddress);
                    return;
                }

                // Must contain at least one of: number, Korean address marker, English address marker
                const hasNumber = /\d/.test(extractedAddress);
                const hasKoreanMarker = /(?:êµ¬|ë™|ë¡œ|ê¸¸|ì‹œ|ë„)/.test(extractedAddress);
                const hasEnglishMarker = /(?:Street|Road|Avenue|Blvd|Lane|Drive|Way|dong|gu|si)/i.test(extractedAddress);

                if (!hasNumber && !hasKoreanMarker && !hasEnglishMarker) {
                    console.log('No address markers found, ignoring:', extractedAddress);
                    return;
                }

                // If we found a valid address, verify it with API
                try {
                    const response = await fetch(`/api/auth/search-address?query=${encodeURIComponent(extractedAddress)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.address && data.address !== extractedAddress) {
                            // Use the formal address from API
                            locationEl.value = data.address;
                            console.log('Address verified via API:', data.address);
                        } else {
                            // Use extracted address if API didn't return better result
                            locationEl.value = extractedAddress;
                            console.log('Address extracted:', extractedAddress);
                        }
                    } else {
                        // If API fails, use extracted address
                        locationEl.value = extractedAddress;
                        console.log('Address extracted (API not available):', extractedAddress);
                    }
                } catch (error) {
                    console.error('Error verifying address:', error);
                    // If API call fails, use extracted address
                    locationEl.value = extractedAddress;
                }
            }
        }

        function updateAIConfidence(segments) {
            const avgConfidence = segments.reduce((sum, seg) => sum + seg.confidence, 0) / segments.length;
            const confidencePercent = Math.round(avgConfidence * 100);

            const confidenceEl = document.getElementById('aiConfidence');
            if (confidenceEl) {
                confidenceEl.textContent = `AI Confidence: ${confidencePercent}%`;
            }
        }

        function toggleSpeaker() {
            if (!audioElement) {
                showToast('No audio file loaded. Please upload an audio file first.', 'warning');
                return;
            }

            const speakerBtn = document.getElementById('speakerBtn');

            if (audioElement.paused) {
                audioElement.play();
                if (speakerBtn) {
                    speakerBtn.classList.add('active');
                }
            } else {
                audioElement.pause();
                if (speakerBtn) {
                    speakerBtn.classList.remove('active');
                }
            }
        }

        function playAudio() {
            // Keep for compatibility - just call toggleSpeaker
            toggleSpeaker();
        }

        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // Create initial emergency record when call starts (for checklist saving during call)
        async function createInitialEmergency() {
            if (currentEmergencyId) {
                console.log('Emergency record already exists:', currentEmergencyId);
                return; // Already created
            }

            try {
                // Get operator ID from session
                const user = JSON.parse(sessionStorage.getItem('user'));
                const operatorId = user ? user.id : null;

                if (!operatorId) {
                    console.error('Operator ID not found in session');
                    return;
                }

                // Get language from detected language or default to Korean
                const language = detectedLanguage || 'ko';

                // Get caller information (from upload result)
                const callerPhoneNumber = '010-8734-2910';
                const callerName = 'Minsu Kim';

                // Get call started time
                const callStartedAtMs = callStartTime ? callStartTime.getTime() : Date.now();

                console.log('Creating initial emergency record:', {
                    callerPhoneNumber,
                    operatorId,
                    language,
                    callStartedAtMs
                });

                // Call complete emergency API with minimal data
                const response = await fetch('/api/auth/complete-emergency', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        callerPhoneNumber: callerPhoneNumber,
                        callerName: callerName,
                        operatorId: operatorId,
                        language: language,
                        transcript: '', // Empty initially
                        totalDurationMs: 0,
                        speakersCount: 0,
                        utterancesCount: 0,
                        incidentType: null,
                        callerLocation: null,
                        mediaAssetId: mediaAssetId,
                        callStartedAtMs: callStartedAtMs,
                        callEndedAtMs: null // Not ended yet
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Store emergency ID and caller ID for checklist saving
                    currentEmergencyId = result.emergencyId;
                    currentCallerId = result.callerId;
                    console.log('Initial emergency record created:', result.emergencyId);
                } else {
                    console.error('Failed to create initial emergency:', result.message);
                }
            } catch (error) {
                console.error('Error creating initial emergency:', error);
            }
        }

        // Complete emergency call and save to database
        async function completeEmergency() {
            if (!transcriptSegments || transcriptSegments.length === 0) {
                console.warn('No transcript segments available');
                return;
            }

            try {
                // Calculate call statistics
                const lastSegment = transcriptSegments[transcriptSegments.length - 1];
                const totalDurationMs = Math.round(lastSegment.endTime * 1000); // Convert to milliseconds

                // Count unique speakers
                const speakersCount = new Set(transcriptSegments.map(seg => seg.speakerId)).size;

                // Count total utterances
                const utterancesCount = transcriptSegments.length;

                // Get incident type from UI
                const incidentTypeEl = document.getElementById('incidentType');
                const incidentType = incidentTypeEl ? incidentTypeEl.value : null;

                // Get caller location from UI
                const callerLocationEl = document.getElementById('incidentLocation');
                const callerLocation = callerLocationEl ? callerLocationEl.value : null;

                // Get call ended time (from timeline)
                const callEndedAtMs = callEndTime ? callEndTime.getTime() : Date.now();

                console.log('Completing emergency with data:', {
                    emergencyId: currentEmergencyId,
                    totalDurationMs,
                    speakersCount,
                    utterancesCount,
                    incidentType,
                    callerLocation,
                    callEndedAtMs,
                    transcriptLength: accumulatedTranscript.length
                });

                // Complete the emergency record with final details
                if (currentEmergencyId) {
                    const user = JSON.parse(sessionStorage.getItem('user'));
                    const operatorId = user ? user.id : null;

                    const completeData = {
                        emergencyId: currentEmergencyId,
                        callerPhoneNumber: '010-8734-2910',
                        operatorId: operatorId,
                        language: detectedLanguage || 'ko',
                        transcript: accumulatedTranscript,
                        totalDurationMs: totalDurationMs,
                        speakersCount: speakersCount,
                        utterancesCount: utterancesCount,
                        incidentType: incidentType,
                        callerLocation: callerLocation,
                        callStartedAtMs: callStartTime ? callStartTime.getTime() : null,
                        callEndedAtMs: callEndedAtMs,
                        isUpdate: true  // Flag to indicate this is an update
                    };

                    const response = await fetch('/api/auth/complete-emergency', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(completeData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('Emergency completed successfully:', currentEmergencyId);

                        // Update UI with risk level from backend
                        if (result.riskLevel !== undefined && result.riskLevel !== null) {
                            const severityLevelEl = document.getElementById('severityLevel');
                            if (severityLevelEl) {
                                severityLevelEl.value = result.riskLevel;
                                console.log('Updated Severity Level to:', result.riskLevel);
                            }
                        }

                        if (result.riskLevelReason) {
                            console.log('Risk Level Reason:', result.riskLevelReason);
                        }
                    } else {
                        console.error('Failed to complete emergency:', result.message);
                        showToast('Failed to complete emergency record: ' + result.message, 'error');
                    }
                } else {
                    console.warn('No emergency ID found, skipping completion');
                }
            } catch (error) {
                console.error('Error completing emergency:', error);
                showToast('Error updating emergency record. Please check the console for details.', 'error');
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('user');
            window.location.href = 'ecall-intro.html';
        }

        // Incoming Call Simulation
        let incomingCallTimer = null;
        let ringtoneAudio = null;
        let ringtoneInterval = null;
        const INCOMING_CALL_NUMBER = '010-1234-5678';
        const INCOMING_CALLER_NAME = 'ê¹€ì—°ì„¸';
        const INCOMING_CALLER_AGE = 30;
        const INCOMING_CALLER_GENDER = 'ì—¬ìž';

        // Get ringtone audio element
        let audioInitialized = false;
        window.addEventListener('DOMContentLoaded', function() {
            ringtoneAudio = document.getElementById('ringtoneAudio');
            if (ringtoneAudio) {
                ringtoneAudio.volume = 0.3;
                ringtoneAudio.loop = false;
            }

            // Initialize audio on first user interaction
            const initAudio = () => {
                if (!audioInitialized && ringtoneAudio) {
                    // Try to play and immediately pause to "unlock" audio
                    ringtoneAudio.play().then(() => {
                        ringtoneAudio.pause();
                        ringtoneAudio.currentTime = 0;
                        audioInitialized = true;
                        console.log('Audio initialized successfully');
                    }).catch(err => {
                        console.log('Audio initialization failed:', err);
                    });
                }
            };

            // Listen for any user interaction
            document.addEventListener('click', initAudio, { once: true });
            document.addEventListener('keydown', initAudio, { once: true });
            document.addEventListener('touchstart', initAudio, { once: true });
        });

        // Multiple audio files for random selection
        const AUDIO_FILES = [
            'https://oeeffpldhwajfmiidayr.supabase.co/storage/v1/object/public/ecall-audio/ecall_simulation_sample_crime.mp3'
            // Add more audio file URLs here as you upload them to Supabase
            // 'https://oeeffpldhwajfmiidayr.supabase.co/storage/v1/object/public/ecall-audio/emergency-2.mp3',
            // 'https://oeeffpldhwajfmiidayr.supabase.co/storage/v1/object/public/ecall-audio/emergency-3.mp3'
        ];

        // Get random audio URL from the list
        function getRandomAudioUrl() {
            const randomIndex = Math.floor(Math.random() * AUDIO_FILES.length);
            const selectedUrl = AUDIO_FILES[randomIndex];
            console.log(`Selected audio file ${randomIndex + 1}/${AUDIO_FILES.length}: ${selectedUrl}`);
            return selectedUrl;
        }

        // Start incoming call timer on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, starting incoming call timer (1 second)...');
            incomingCallTimer = setTimeout(showIncomingCall, 1000); // 1 second
        });

        function showIncomingCall() {
            console.log('Showing incoming call notification');
            const notification = document.getElementById('incomingCallNotification');
            if (notification) {
                notification.classList.add('show');
            }

            // Play ringtone repeatedly
            if (ringtoneAudio) {
                ringtoneInterval = setInterval(() => {
                    ringtoneAudio.currentTime = 0;
                    ringtoneAudio.play().catch(err => {
                        console.log('Could not play ringtone:', err);
                    });
                }, 1000);
            }
        }

        function declineCall() {
            console.log('Call declined');
            const notification = document.getElementById('incomingCallNotification');
            if (notification) {
                notification.classList.remove('show');
            }

            // Stop ringtone
            if (ringtoneInterval) {
                clearInterval(ringtoneInterval);
                ringtoneInterval = null;
            }
            if (ringtoneAudio) {
                ringtoneAudio.pause();
                ringtoneAudio.currentTime = 0;
            }

            showToast('Call declined', 'info');

            // Schedule next call in 15 seconds
            setTimeout(showIncomingCall, 15000);
        }

        async function acceptCall() {
            console.log('Call accepted');
            const notification = document.getElementById('incomingCallNotification');
            if (notification) {
                notification.classList.remove('show');
            }

            // Stop ringtone
            if (ringtoneInterval) {
                clearInterval(ringtoneInterval);
                ringtoneInterval = null;
            }
            if (ringtoneAudio) {
                ringtoneAudio.pause();
                ringtoneAudio.currentTime = 0;
            }

            // Update caller number in UI
            const callerNumberInput = document.getElementById('callerNumber');
            if (callerNumberInput) {
                callerNumberInput.value = INCOMING_CALL_NUMBER;
            }

            showToast(`Call connected from ${INCOMING_CALLER_NAME} - Loading audio...`, 'success');

            try {
                // Get random audio file from the list
                const audioUrl = getRandomAudioUrl();

                // Fetch audio file from Supabase storage
                console.log('Fetching audio from:', audioUrl);
                const response = await fetch(audioUrl);

                if (!response.ok) {
                    throw new Error(`Failed to fetch audio: ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                console.log('Audio fetched, size:', blob.size, 'type:', blob.type);

                // Create File object from blob
                const audioFile = new File([blob], 'emergency-call.mp3', { type: 'audio/mpeg' });

                // Get operator ID from session
                const user = JSON.parse(sessionStorage.getItem('user'));
                const operatorId = user ? user.id : null;

                // Create FormData - same as uploadFile()
                const formData = new FormData();
                formData.append('file', audioFile);
                formData.append('minSpeakers', '1');
                formData.append('maxSpeakers', '5');
                formData.append('language', 'en-US'); // English audio sample - skip auto-detection

                // Add caller and operator information
                formData.append('callerPhoneNumber', INCOMING_CALL_NUMBER);
                formData.append('callerName', INCOMING_CALLER_NAME);
                formData.append('callerAge', INCOMING_CALLER_AGE);
                formData.append('callerGender', INCOMING_CALLER_GENDER);
                if (operatorId) {
                    formData.append('operatorId', operatorId);
                }

                // Call Clova API - same endpoint as uploadFile()
                const clovaResponse = await fetch('/api/voice/upload/clova', {
                    method: 'POST',
                    body: formData
                });

                const result = await clovaResponse.json();
                console.log('Clova API result:', result);
                console.log('Speaker segments:', result.speakerSegments);

                if (result.success && result.speakerSegments) {
                    transcriptSegments = result.speakerSegments;
                    console.log('Transcript segments loaded:', transcriptSegments.length, 'segments');

                    // Store language if returned
                    if (result.language) {
                        detectedLanguage = result.language;
                        console.log('Detected language:', detectedLanguage);
                    }

                    // Store media asset ID if returned
                    if (result.mediaAssetId) {
                        mediaAssetId = result.mediaAssetId;
                        console.log('Media asset ID:', mediaAssetId);
                    }

                    // Create audio element for playback
                    try {
                        const audioElementUrl = URL.createObjectURL(audioFile);
                        audioElement = new Audio(audioElementUrl);

                        // Reset displayed segments
                        displayedSegmentIndexes.clear();

                        // Sync transcript with audio playback
                        audioElement.addEventListener('timeupdate', () => {
                            syncTranscriptWithAudio();
                        });

                        // Auto-play audio and activate speaker button
                        audioElement.play();
                        const speakerBtn = document.getElementById('speakerBtn');
                        if (speakerBtn) {
                            speakerBtn.classList.add('active');
                        }

                        // Remove active class when audio ends
                        audioElement.addEventListener('ended', () => {
                            if (speakerBtn) {
                                speakerBtn.classList.remove('active');
                            }
                        });
                    } catch (audioError) {
                        console.error('Error creating audio element:', audioError);
                    }

                    // Hide empty state
                    const emptyState = document.getElementById('emptyState');
                    if (emptyState) {
                        emptyState.classList.add('hidden');
                    }

                    // Reset timer
                    stopTimer();
                    seconds = 0;

                    // Initialize transcript display
                    initializeTranscriptDisplay();

                    showToast('Call audio loaded successfully', 'success');
                } else {
                    showToast('Failed to process audio file: ' + (result.error || result.message), 'error');
                }
            } catch (error) {
                console.error('Error loading call audio:', error);
                showToast('Failed to load call audio: ' + error.message, 'error');
            }
        }

    </script>
</body>
</html>
