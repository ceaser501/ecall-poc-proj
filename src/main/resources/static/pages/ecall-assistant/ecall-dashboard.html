
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Call AI.ssistant</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3d8af1dddd94ffe1e0d8465532d945f2&libraries=services,drawing"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
        }

        /* Header styles from ecall-assistant.html */
        .header {
            background: white;
            border-bottom: 1px solid rgb(226, 232, 240);
        }

        .header-container {
            max-width: 2400px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-icon {
            background: linear-gradient(135deg, rgb(59, 130, 246) 0%, rgb(37, 99, 235) 100%);
            padding: 0.625rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon svg {
            width: 1.25rem;
            height: 1.25rem;
            color: white;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: rgb(15, 23, 42);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-user-info {
            position: relative;
            display: inline-block;
            margin-right: 1rem;
            cursor: pointer;
        }

        .header-user-name {
            font-size: 0.875rem;
            color: rgb(15, 23, 42);
            font-weight: 500;
        }

        .operator-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .operator-status-dot.on-call { background-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
        .operator-status-dot.available { background-color: #22c55e; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
        .operator-status-dot.away { background-color: #eab308; box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2); }

        .header-user-popup {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border: 1px solid rgb(226, 232, 240);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            min-width: 360px;
            z-index: 1000;
        }

        .header-user-popup.show { display: block; }
        
        .header-user-popup .panel-header {
            background: rgb(248, 250, 252);
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgb(226, 232, 240);
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        .header-user-popup .panel-body { padding: 1.5rem; }
        
        .operator-info { display: flex; align-items: center; gap: 1rem; }
        
        .operator-avatar-lg {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: rgb(226, 232, 240);
            overflow: hidden;
            flex-shrink: 0;
        }

        .operator-avatar-lg img { width: 100%; height: 100%; object-fit: cover; }
        
        .operator-details { display: flex; flex-direction: column; gap: 0.125rem; }
        .operator-name { font-weight: 600; color: rgb(15, 23, 42); }
        .operator-dept { color: rgb(71, 85, 105); font-size: 0.875rem; }
        .operator-exp { color: rgb(100, 116, 139); font-size: 0.875rem; }

        .status-selector { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgb(226, 232, 240); }
        .status-selector-label { font-size: 0.875rem; font-weight: 600; color: rgb(71, 85, 105); margin-bottom: 0.5rem; display: block; }
        .status-options { display: flex; gap: 0.5rem; }
        .status-option { flex: 1; padding: 0.5rem; border: 2px solid rgb(226, 232, 240); border-radius: 0.375rem; cursor: pointer; text-align: center; font-size: 0.75rem; font-weight: 500; transition: all 0.2s; background: white; }
        .status-option:hover { border-color: rgb(148, 163, 184); }
        .status-option.active { background: rgb(241, 245, 249); }
        .status-option.on-call.active { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .status-option.available.active { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); color: #16a34a; }
        .status-option.away.active { border-color: #eab308; background: rgba(234, 179, 8, 0.1); color: #ca8a04; }

        .header-logout-btn { background: #1e293b; color: white; padding: 0.375rem 0.625rem; border: 1px solid #1e293b; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.2s; height: 2rem; display: inline-flex; align-items: center; }
        .header-logout-btn:hover { background: #0f172a; border-color: #0f172a; }
        
        .btn { padding: 0.5rem 1rem; border: 1px solid rgb(226, 232, 240); border-radius: 0.375rem; background: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-icon { width: 2rem; height: 2rem; padding: 0; display: flex; align-items: center; justify-content: center; }
        .btn svg { width: 1rem; height: 1rem; }

        /* Main Content */
        .main-content { padding: 24px 32px; max-width: 1920px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); display: flex; align-items: flex-start; gap: 16px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .stat-icon svg { width: 24px; height: 24px; color: white; }
        .stat-info { flex: 1; }
        .stat-label { font-size: 14px; color: #6b7280; margin-bottom: 2px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #1d1d1f; }
        .stat-sub-label { font-size: 12px; color: #9ca3af; margin-top: 4px; }
        
        .content-grid { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 20px; }
        .panel { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); max-height: 80vh; overflow-y: auto; }
        .panel-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1d1d1f; }
        .filter-buttons { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 14px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .filter-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .filter-btn:hover:not(.active) { background: #f9fafb; }
        .incident-item { padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; }
        .incident-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .category-badge { padding: 5px 12px; border-radius: 6px; font-size: 14px; font-weight: 600; color: white; }
        .category-disaster { background-color: #f59e0b; }
        .category-medical { background-color: #10b981; }
        .category-crime { background-color: #3b82f6; }
        .category-traffic { background-color: #facc15; color: #1d1d1f;}
        .category-rescue { background-color: #8b5cf6; }
        .category-other { background-color: #6b7280; }
        .urgency-level { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .urgency-1 { background-color: #374151; color: white; }
        .urgency-2 { background-color: #6b7280; color: white; }
        .urgency-3 { background-color: #9ca3af; color: white; }
        .urgency-4 { background-color: #d1d5db; color: #1f2937; }
        .urgency-5 { background-color: #e5e7eb; color: #1f2937; }
        .incident-details { font-size: 13px; color: #6b7280; line-height: 1.6; }
        .detail-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .detail-item img { width: 14px; height: 14px; opacity: 0.7; }
        .incident-status { font-weight: 600; }
        .status-handling { color: #f59e0b; }
        .status-assigned { color: #3b82f6; }
        .status-on-scene { color: #8b5cf6; }
        .status-closed { color: #10b981; }
        .incident-actions { display: flex; gap: 8px; margin-top: 16px; }
        .action-btn { flex: 1; padding: 8px 16px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .action-btn.primary { background: #2563eb; color: white; border-color: #2563eb; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .action-btn:disabled { background-color: #f3f4f6; cursor: not-allowed; transform: none; box-shadow: none; }
        .map-container { height: 400px; background: #f3f4f6; border-radius: 8px; position: relative; margin-bottom: 16px; overflow: hidden; }
        .map-legend { display: none; } /* Hide map legend */
        .resource-item { margin-bottom: 20px; }
        .resource-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .resource-name { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .resource-count { font-size: 13px; color: #6b7280; }
        .resource-bar { height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden; display: flex; }
        .bar-segment { height: 100%; }
        .bar-segment.green { background: #10b981; }
        .bar-segment.yellow { background: #f59e0b; }
        .bar-segment.red { background: #ef4444; }
        .dispatch-item { padding: 12px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
        .dispatch-item:last-child { border-bottom: none; }
        .dispatch-info { flex: 1; }
        .dispatch-time { font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 2px; }
        .dispatch-type { font-size: 13px; color: #6b7280; }
        .dispatch-unit { font-size: 12px; color: #9ca3af; }
        .dispatch-eta { font-size: 12px; color: #6b7280; text-align: right; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s; backdrop-filter: blur(4px); }
        .modal-overlay.visible { visibility: visible; opacity: 1; }
        .modal-content { background: #f8fafc; padding: 0; border-radius: 12px; width: 95%; max-width: 1400px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); transform: scale(0.95); transition: transform 0.3s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
        .modal-title { font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #9ca3af; }
        .modal-body { padding: 0; overflow-y: auto; flex-grow: 1; }
        
        /* Reception Modal Layout */
        .reception-modal-grid { display: grid; grid-template-columns: 3fr 6fr 3fr; height: 100%; }
        .reception-col { padding: 1.5rem; border-right: 1px solid #e2e8f0; }
        .reception-col:last-child { border-right: none; }
        .reception-section { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem; }
        .reception-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151; display: flex; align-items: center; gap: 0.5rem; }
        .reception-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; display: block; }
        .reception-value { font-size: 0.9rem; color: #111827; background: #f9fafb; padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
        .reception-map { height: 100%; min-height: 400px; background: #f3f4f6; border-radius: 0.75rem; }
        .reception-timeline-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; padding: 0.5rem 0; border-bottom: 1px dashed #e2e8f0; }
        .reception-timeline-item:last-child { border-bottom: none; }
        .reception-manual-item { background: #f9fafb; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; color: #374151; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.2s; }
        .reception-manual-item:hover { background-color: #f3f4f6; }

        @media (max-width: 1200px) { .reception-modal-grid { grid-template-columns: 1fr 1fr; } .reception-col.col-right { display: none; } }
        @media (max-width: 768px) { .reception-modal-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-container">
            <div class="header-left">
                <div class="header-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                </div>
                <h1 class="header-title">Comprehensive Dashboard</h1>
            </div>

            <div class="header-right">
                <div class="header-user-info">
                    <span class="header-user-name" id="headerUserName">Loading...</span>
                    <span class="operator-status-dot available" id="operatorStatusDot"></span>
                    <div class="header-user-popup">
                        <div class="panel-header">
                            <h3 class="panel-title">Operator Information</h3>
                        </div>
                        <div class="panel-body">
                            <div class="operator-info">
                                <div class="operator-avatar-lg">
                                    <img id="headerOperatorAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'%3E%3Crect fill='%23e2e8f0' width='64' height='64'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='%2364748b'%3E%3F%3C/text%3E%3C/svg%3E" alt="Operator">
                                </div>
                                <div class="operator-details">
                                    <p id="headerOperatorName" class="operator-name">Unknown</p>
                                    <p id="headerOperatorDept" class="operator-dept">N/A</p>
                                    <p id="headerOperatorExp" class="operator-exp">N/A</p>
                                </div>
                            </div>
                            <div class="status-selector">
                                <span class="status-selector-label">Status</span>
                                <div class="status-options">
                                    <div class="status-option on-call" onclick="changeOperatorStatus('on-call')">On Call</div>
                                    <div class="status-option available" onclick="changeOperatorStatus('available')">Available</div>
                                    <div class="status-option away" onclick="changeOperatorStatus('away')">Away</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-icon" onclick="window.location.href='ecall-intro.html'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </button>
                <button class="btn btn-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                </button>
                <button class="header-logout-btn" onclick="logout()">
                    Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #4f46e5;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Total Reports</div>
                    <div class="stat-value" id="total-reports-stat">0</div>
                    <div class="stat-sub-label">Live Update</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #db2777;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Ongoing Incidents</div>
                    <div class="stat-value" id="ongoing-incidents-stat">0</div>
                    <div class="stat-sub-label">In Progress</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #16a34a;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Total Dispatches</div>
                    <div class="stat-value" id="total-dispatches-stat">0</div>
                    <div class="stat-sub-label" id="dispatch-rate-label">Dispatch Rate: 0%</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #d97706;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <div class="stat-info">
                    <div class="stat-label">Units Available</div>
                    <div class="stat-value" id="units-available-stat">0</div>
                    <div class="stat-sub-label">Ready for Dispatch</div>
                </div>
            </div>
        </div>

        <!-- Three Column Layout -->
        <div class="content-grid">
            <!-- Active Call (Dynamically Generated) -->
            <div class="panel">
                <h2 class="panel-title">Active Calls</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="All">All</button>
                    <button class="filter-btn" data-filter="Disaster">Disaster</button>
                    <button class="filter-btn" data-filter="Medical">Medical</button>
                    <button class="filter-btn" data-filter="Crime">Crime</button>
                    <button class="filter-btn" data-filter="Traffic">Traffic</button>
                    <button class="filter-btn" data-filter="Rescue">Rescue</button>
                    <button class="filter-btn" data-filter="Other">Other</button>
                </div>
                <div id="incident-list">
                    <!-- Incident items will be dynamically inserted here -->
                </div>
            </div>

            <!-- Live Incidents Map -->
            <div class="panel">
                <h2 class="panel-title">Live Incidents Map</h2>
                <div id="map" class="map-container"></div>
                <div class="map-legend">
                    <!-- This will be hidden by CSS -->
                </div>
            </div>

            <!-- Resources & Dispatches -->
            <div>
                <div class="panel" style="margin-bottom: 20px;">
                    <h2 class="panel-title">Resources Now</h2>
                    <div class="resource-item">
                        <div class="resource-header">
                            <div class="resource-name"><img src="/assets/images/ecallAssistant_icon/Icon-2.png" alt="Fire" style="width: 16px; height: 16px;"> Fire</div>
                            <div class="resource-count">9 / 2 / 3</div>
                        </div>
                        <div class="resource-bar">
                            <div class="bar-segment green" style="flex: 9;"></div><div class="bar-segment yellow" style="flex: 2;"></div><div class="bar-segment red" style="flex: 3;"></div>
                        </div>
                    </div>
                    <div class="resource-item">
                        <div class="resource-header">
                            <div class="resource-name"><img src="/assets/images/ecallAssistant_icon/Icon-1.png" alt="EMS" style="width: 16px; height: 16px;"> EMS</div>
                            <div class="resource-count">8 / 3 / 1</div>
                        </div>
                        <div class="resource-bar">
                            <div class="bar-segment green" style="flex: 8;"></div><div class="bar-segment yellow" style="flex: 3;"></div><div class="bar-segment red" style="flex: 1;"></div>
                        </div>
                    </div>
                    <div class="resource-item">
                        <div class="resource-header">
                            <div class="resource-name"><img src="/assets/images/ecallAssistant_icon/Icon-3.png" alt="Police" style="width: 16px; height: 16px;"> Police</div>
                            <div class="resource-count">6 / 1 / 2</div>
                        </div>
                        <div class="resource-bar">
                            <div class="bar-segment green" style="flex: 6;"></div><div class="bar-segment yellow" style="flex: 1;"></div><div class="bar-segment red" style="flex: 2;"></div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="panel-title">Recent Dispatches</h2>
                    <div class="dispatch-item"><div class="dispatch-info"><div class="dispatch-time">10:18</div><div class="dispatch-type">Fire</div><div class="dispatch-unit">E-12</div></div><div class="dispatch-eta">ETA 4 min</div></div>
                    <div class="dispatch-item"><div class="dispatch-info"><div class="dispatch-time">10:15</div><div class="dispatch-type">Medical</div><div class="dispatch-unit">A-03</div></div><div class="dispatch-eta">ETA 2 min</div></div>
                    <div class="dispatch-item"><div class="dispatch-info"><div class="dispatch-time">10:12</div><div class="dispatch-type">Police</div><div class="dispatch-unit">P-45</div></div><div class="dispatch-eta">ETA 6 min</div></div>
                    <div class="dispatch-item"><div class="dispatch-info"><div class="dispatch-time">10:09</div><div class="dispatch-type">Fire</div><div class="dispatch-unit">L-07</div></div><div class="dispatch-eta">ETA 8 min</div></div>
                    <div class="dispatch-item"><div class="dispatch-info"><div class="dispatch-time">10:05</div><div class="dispatch-type">Medical</div><div class="dispatch-unit">A-11</div></div><div class="dispatch-eta">ETA 1 min</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Info Modal -->
    <div id="agentInfoModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Operator Information</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="agentInfoBody">
                <!-- Agent info will be populated here -->
            </div>
        </div>
    </div>

    <!-- Responder Info Modal -->
    <div id="responderInfoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="responderModalTitle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    <span>Dispatch Details</span>
                </h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="responderInfoBody">
                <!-- Responder info will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // DATA
        // =================================================================
        let allIncidents = [];
        
        const incidentData = [
            { id: 'incident-1', category: 'Medical', urgency: 2, address: '134 Sinchon-dong, Seodaemun-gu, Seoul', lat: 37.5602, lng: 126.9423, time: '14:32 ~ 14:38', agent: { name: 'Operator 1', department: 'Seoul Central', phone: '010-1234-5678', photoUrl: '/assets/images/portraits/operator1.png' }, status: 'Dispatch Assigned', statusClass: 'status-assigned', responder: { name: 'Firefighter Kim', unit: 'Engine 12', status: 'En route', eta: '3 min', lat: 37.564923, lng: 126.938441, photoUrl: '/assets/images/portraits/firefighter1.png' }, disabled: false },
            { id: 'incident-2', category: 'Traffic', urgency: 4, address: '57-1 Nogosan-dong, Mapo-gu, Seoul', lat: 37.5551, lng: 126.9369, time: '14:28 ~ 14:35', agent: { name: 'Operator 2', department: 'Mapo Station', phone: '010-2345-6789', photoUrl: '/assets/images/portraits/operator2.png' }, status: 'On Scene', statusClass: 'status-on-scene', responder: { name: 'Officer Park', unit: 'Patrol 34', status: 'On Scene', eta: '0 min', lat: 37.5551, lng: 126.9369, photoUrl: '/assets/images/portraits/patrol1.png' }, disabled: false },
            { id: 'incident-3', category: 'Crime', urgency: 1, address: '200-1 Yeonhui-dong, Seodaemun-gu, Seoul', lat: 37.5731, lng: 126.9358, time: '14:25 ~ (Ongoing)', agent: { name: 'Operator 1', department: 'Seoul Central', phone: '010-1234-5678', photoUrl: '/assets/images/portraits/operator1.png' }, status: 'Handling Call', statusClass: 'status-handling', responder: { name: 'Detective Lee', unit: 'Unit 1', status: 'Preparing', eta: '10 min', lat: 37.57, lng: 126.93, photoUrl: '/assets/images/portraits/patrol1.png' }, disabled: false },
            { id: 'incident-4', category: 'Rescue', urgency: 3, address: 'San 1-1, Bugahyeon-dong, Seodaemun-gu, Seoul', lat: 37.5659, lng: 126.9533, time: '14:10 ~ 14:22', agent: { name: 'Operator 3', department: 'Seodaemun Station', phone: '010-3456-7890', photoUrl: '/assets/images/portraits/operator3.png' }, status: 'Closed', statusClass: 'status-closed', responder: { name: 'Rescue Team Choi', unit: 'Rescue 2', status: 'Returned', eta: '-', lat: 37.57, lng: 126.94, photoUrl: '/assets/images/portraits/ems1.png' }, disabled: true },
        ];

        // =================================================================
        // INITIALIZATION
        // =================================================================
        document.addEventListener("DOMContentLoaded", async function() {
            updateAuthUI();
            initializeMap(); // Initialize map first
            
            // Use hardcoded data for now
            allIncidents = incidentData;
            renderIncidentList(allIncidents);
            addIncidentMarkers(allIncidents); // Then add markers
            updateStats(allIncidents);

            setupEventListeners();
        });

        // =================================================================
        // UI RENDERING & EVENT LISTENERS
        // =================================================================
        function renderIncidentList(data) {
            const listContainer = document.getElementById('incident-list');
            listContainer.innerHTML = ''; // Clear existing list

            if (!data || data.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:#6b7280; padding: 2rem 0;">No incidents to display.</p>';
                return;
            }

            data.forEach(incident => {
                const disabledAttribute = incident.disabled ? 'disabled' : '';
                const itemHTML = `
                    <div class="incident-item" id="${incident.id}" data-incident='${JSON.stringify(incident)}'>
                        <div class="incident-header">
                            <span class="category-badge category-${incident.category.toLowerCase()}">${incident.category}</span>
                            <span class="urgency-level urgency-${incident.urgency}">Urgency ${incident.urgency}</span>
                        </div>
                        <div class="incident-details">
                            <div class="detail-item">
                                <img src="/assets/images/ecallAssistant_icon/Icon-10.png" alt="Location">
                                <span>${incident.address}</span>
                            </div>
                            <div class="detail-item">
                                <img src="/assets/images/ecallAssistant_icon/Icon-8.png" alt="Time">
                                <span>${incident.time}</span>
                            </div>
                            <div class="detail-item">
                                <img src="/assets/images/ecallAssistant_icon/Icon-1.png" alt="Agent">
                                <span>Agent: ${incident.agent.name}</span>
                            </div>
                            <div class="detail-item">
                                <img src="/assets/images/ecallAssistant_icon/Icon-13.png" alt="Status">
                                <span class="incident-status ${incident.statusClass}">${incident.status}</span>
                            </div>
                        </div>
                        <div class="incident-actions">
                            <button class="action-btn agent-info-btn">Operator</button>
                            <button class="action-btn responder-info-btn" ${disabledAttribute}>Assigned Team</button>
                        </div>
                    </div>
                `;
                listContainer.innerHTML += itemHTML;
            });
        }

        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filterCategory = this.dataset.filter;
                    const filteredData = (filterCategory === 'All')
                        ? allIncidents
                        : allIncidents.filter(incident => incident.category === filterCategory);
                    renderIncidentList(filteredData);
                    filterMapMarkers(filterCategory);
                });
            });

            // Modal Logic
            const agentModal = document.getElementById('agentInfoModal');
            const responderModal = document.getElementById('responderInfoModal');
            const agentModalBody = document.getElementById('agentInfoBody');
            const responderModalBody = document.getElementById('responderInfoBody');

            document.getElementById('incident-list').addEventListener('click', function(e) {
                const target = e.target;
                const incidentItem = target.closest('.incident-item');
                if (!incidentItem) return;

                const incident = JSON.parse(incidentItem.dataset.incident);

                if (target.classList.contains('agent-info-btn')) {
                    agentModal.querySelector('.modal-title').textContent = 'Operator Information';
                    agentModalBody.innerHTML = `
                        <div class="operator-info" style="padding: 1.5rem;">
                            <div class="operator-avatar-lg">
                                <img src="${incident.agent.photoUrl}" alt="Agent">
                            </div>
                            <div class="operator-details">
                                <p class="operator-name">${incident.agent.name}</p>
                                <p class="operator-dept">${incident.agent.department}</p>
                            </div>
                        </div>
                    `;
                    agentModal.classList.add('visible');
                }

                if (target.classList.contains('responder-info-btn')) {
                    document.getElementById('responderModalTitle').querySelector('span').textContent = `Dispatch Details â€” ${incident.id.replace('incident-','ECA')}`;
                    responderModalBody.innerHTML = `
                        <div class="reception-modal-grid">
                            <!-- Left Column -->
                            <div class="reception-col">
                                <div class="reception-section">
                                    <h3 class="reception-section-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                        Incident Information
                                    </h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="reception-label">Incident Type</label>
                                            <div class="reception-value">${incident.category}</div>
                                        </div>
                                        <div>
                                            <label class="reception-label">Severity Level</label>
                                            <div class="reception-value">Urgency ${incident.urgency}</div>
                                        </div>
                                        <div>
                                            <label class="reception-label">Incident Location</label>
                                            <div class="reception-value">${incident.address}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="reception-section">
                                    <h3 class="reception-section-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                        Assigned Team
                                    </h3>
                                    <div class="operator-info">
                                        <div class="operator-avatar-lg" style="width: 3.5rem; height: 3.5rem;">
                                            <img src="${incident.responder.photoUrl}" alt="Responder">
                                        </div>
                                        <div class="operator-details">
                                            <p class="operator-name">${incident.responder.name}</p>
                                            <p class="operator-dept">${incident.responder.unit}</p>
                                            <p class="operator-exp">Status: ${incident.responder.status} | ETA: ${incident.responder.eta}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Center Column -->
                            <div class="reception-col">
                                <div id="responderMap" class="reception-map"></div>
                            </div>
                            <!-- Right Column -->
                            <div class="reception-col col-right">
                                <div class="reception-section">
                                    <h3 class="reception-section-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>
                                        Operator Information
                                    </h3>
                                    <div class="operator-info">
                                        <div class="operator-avatar-lg" style="width: 3.5rem; height: 3.5rem;">
                                            <img src="${incident.agent.photoUrl}" alt="Agent">
                                        </div>
                                        <div class="operator-details">
                                            <p class="operator-name">${incident.agent.name}</p>
                                            <p class="operator-dept">${incident.agent.department}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="reception-section">
                                    <h3 class="reception-section-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                        Response Manual
                                    </h3>
                                    <div class="reception-manual-item">CPR Procedure</div>
                                    <div class="reception-manual-item">Bleeding Control</div>
                                </div>
                                <div class="reception-section">
                                    <h3 class="reception-section-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>
                                        Timeline
                                    </h3>
                                    <div class="reception-timeline-item">
                                        <span>Call Started</span><span>${incident.time.split('~')[0].trim()}</span>
                                    </div>
                                    <div class="reception-timeline-item">
                                        <span>Dispatch Assigned</span><span>${incident.time.split('~')[0].trim()}</span>
                                    </div>
                                    <div class="reception-timeline-item">
                                        <span>On Scene</span><span>${incident.status === 'On Scene' ? incident.time.split('~')[1].trim() : '-'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    responderModal.classList.add('visible');
                    
                    // Initialize map inside the modal
                    setTimeout(() => {
                        const responderMapContainer = document.getElementById('responderMap');
                        if (responderMapContainer && responderMapContainer.offsetParent !== null) {
                            const responderMapOption = {
                                center: new kakao.maps.LatLng(incident.lat, incident.lng),
                                level: 7
                            };
                            const responderMap = new kakao.maps.Map(responderMapContainer, responderMapOption);
                            
                            const incidentPosition = new kakao.maps.LatLng(incident.lat, incident.lng);
                            const responderPosition = new kakao.maps.LatLng(incident.responder.lat, incident.responder.lng);

                            new kakao.maps.Marker({ position: incidentPosition, map: responderMap });
                            new kakao.maps.Marker({ position: responderPosition, map: responderMap });

                            const directionsService = new kakao.maps.services.Directions();
                            const walkRouteOptions = {
                                origin: responderPosition,
                                destination: incidentPosition,
                                travelMode: kakao.maps.services.TravelMode.WALKING
                            };

                            directionsService.get(walkRouteOptions, function(result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    const linePath = [];
                                    result.routes[0].sections.forEach(section => {
                                        section.roads.forEach(road => {
                                            for (let i = 0; i < road.vertexes.length; i += 2) {
                                                linePath.push(new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]));
                                            }
                                        });
                                    });

                                    const routePolyline = new kakao.maps.Polyline({
                                        path: linePath,
                                        strokeWeight: 5,
                                        strokeColor: '#EF4444',
                                        strokeOpacity: 0.9,
                                        strokeStyle: 'solid'
                                    });
                                    routePolyline.setMap(responderMap);
                                } else {
                                    // Fallback to straight line if routing fails
                                    const polyline = new kakao.maps.Polyline({
                                        path: [responderPosition, incidentPosition],
                                        strokeWeight: 3,
                                        strokeColor: '#FF0000',
                                        strokeOpacity: 0.8,
                                        strokeStyle: 'solid'
                                    });
                                    polyline.setMap(responderMap);
                                }

                                const bounds = new kakao.maps.LatLngBounds();
                                bounds.extend(incidentPosition);
                                bounds.extend(responderPosition);
                                responderMap.setBounds(bounds);
                            });
                        }
                    }, 100);
                }
            });

            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal-overlay').classList.remove('visible');
                });
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                    }
                });
            });
            
            // Header user info popup
            const headerUserInfo = document.querySelector('.header-user-info');
            const headerUserPopup = document.querySelector('.header-user-popup');
            let popupTimeout;

            if (headerUserInfo && headerUserPopup) {
                headerUserInfo.addEventListener('mouseenter', () => {
                    clearTimeout(popupTimeout);
                    headerUserPopup.classList.add('show');
                });
                headerUserPopup.addEventListener('mouseenter', () => {
                    clearTimeout(popupTimeout);
                });
                headerUserInfo.addEventListener('mouseleave', () => {
                    popupTimeout = setTimeout(() => headerUserPopup.classList.remove('show'), 200);
                });
                headerUserPopup.addEventListener('mouseleave', () => {
                    popupTimeout = setTimeout(() => headerUserPopup.classList.remove('show'), 200);
                });
            }
        }

        function updateStats(data) {
            const totalReports = data.length;
            const onGoing = data.filter(d => !d.disabled).length;
            const totalDispatches = data.filter(d => d.status !== 'Handling Call').length;
            const dispatchRate = totalReports > 0 ? Math.round((totalDispatches / totalReports) * 100) : 0;

            let unitsAvailable = 0;
            document.querySelectorAll('.resource-count').forEach(el => {
                const counts = el.textContent.split('/').map(s => parseInt(s.trim()));
                if (counts.length > 0) {
                    unitsAvailable += counts[0];
                }
            });

            document.getElementById('total-reports-stat').textContent = totalReports;
            document.getElementById('ongoing-incidents-stat').textContent = onGoing;
            document.getElementById('total-dispatches-stat').textContent = totalDispatches;
            document.getElementById('dispatch-rate-label').textContent = `Dispatch Rate: ${dispatchRate}%`;
            document.getElementById('units-available-stat').textContent = unitsAvailable;
        }
        
        function logout() {
            sessionStorage.removeItem('user');
            window.location.href = 'ecall-intro.html';
        }

        function updateAuthUI() {
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (!user) {
                window.location.href = 'ecall-intro.html';
                return;
            }

            const headerUserName = document.getElementById('headerUserName');
            const headerOperatorName = document.getElementById('headerOperatorName');
            const headerOperatorDept = document.getElementById('headerOperatorDept');
            const headerOperatorExp = document.getElementById('headerOperatorExp');
            const headerOperatorAvatar = document.getElementById('headerOperatorAvatar');

            headerUserName.textContent = `${user.name} (${user.organizationName || 'N/A'})`;
            headerOperatorName.textContent = user.name || 'Unknown';
            headerOperatorDept.textContent = user.organizationName || 'N/A';
            
            if (user.joinDate) {
                const joinDate = new Date(user.joinDate.split('T')[0]);
                const yearsDiff = new Date().getFullYear() - joinDate.getFullYear();
                headerOperatorExp.textContent = `${yearsDiff} year${yearsDiff !== 1 ? 's' : ''} exp.`;
            }
            
            if (user.photoUrl) {
                headerOperatorAvatar.src = user.photoUrl;
            } else {
                // Use default operator image based on operatorId or name
                const operatorNum = user.operatorId ? (parseInt(user.operatorId) % 3) + 1 : 1;
                headerOperatorAvatar.src = `/assets/images/portraits/operator${operatorNum}.png`;
            }
            
            loadOperatorStatus();
        }
        
        function changeOperatorStatus(status) {
            const statusDot = document.getElementById('operatorStatusDot');
            if (statusDot) {
                statusDot.className = `operator-status-dot ${status}`;
            }

            const statusOptions = document.querySelectorAll('.status-option');
            statusOptions.forEach(option => {
                option.classList.remove('active');
                if (option.classList.contains(status)) {
                    option.classList.add('active');
                }
            });
            localStorage.setItem('operatorStatus', status);
        }

        function loadOperatorStatus() {
            const savedStatus = localStorage.getItem('operatorStatus') || 'available';
            changeOperatorStatus(savedStatus);
        }

        // =================================================================
        // KAKAO MAP INTEGRATION
        // =================================================================
        let map;
        let markers = [];
        let infowindow;

        function initializeMap() {
            if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
                console.error("Kakao Maps API not loaded.");
                document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; color: red;">Kakao Maps API could not be loaded.</div>';
                return;
            }

            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.5659, 126.9384), // Yonsei University
                level: 5 // Zoom level
            };

            map = new kakao.maps.Map(mapContainer, mapOption);
            infowindow = new kakao.maps.InfoWindow({ zIndex: 1, removable: true });
        }

        function addIncidentMarkers(data) {
            if (!map) return;
            const bounds = new kakao.maps.LatLngBounds();
            
            data.forEach(incident => {
                if (!incident.lat || !incident.lng) return;

                const position = new kakao.maps.LatLng(incident.lat, incident.lng);
                const pinColor = '#3b82f6'; // Unified blue color
                const pinSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="40" viewBox="0 0 24 34">` +
                               `<path fill="${pinColor}" stroke="white" stroke-width="1.5" d="M12 0C7.03 0 3 4.03 3 9c0 6.17 7.43 15.45 8.23 16.5.4.53 1.14.53 1.54 0 .8-.95 8.23-10.33 8.23-16.5C21 4.03 16.97 0 12 0zm0 12.5c-1.93 0-3.5-1.57-3.5-3.5S10.07 5.5 12 5.5s3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>` +
                               `</svg>`;
                const imageSrc = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(pinSVG)}`;
                const imageSize = new kakao.maps.Size(28, 40);
                const imageOption = { offset: new kakao.maps.Point(14, 40) };
                const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
                
                const marker = new kakao.maps.Marker({
                    map: map,
                    position: position,
                    title: `[${incident.category}] ${incident.address}`,
                    image: markerImage
                });
                
                marker.incident = incident; // Attach incident data to marker

                kakao.maps.event.addListener(marker, 'click', function() {
                    showIncidentInfo(marker, incident);
                });

                markers.push(marker);
                bounds.extend(position);
            });

            if (markers.length > 0) {
                map.setBounds(bounds);
            }
        }

        function showIncidentInfo(marker, incident) {
            infowindow.close();
            const content = `
                <div style="padding:10px;font-size:13px;min-width:250px;line-height:1.6;">
                    <div style="font-weight:bold;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                        <span class="category-badge category-${incident.category.toLowerCase()}">${incident.category}</span>
                        <span class="urgency-level urgency-${incident.urgency}">Urgency ${incident.urgency}</span>
                    </div>
                    <div style="margin-bottom:4px;">
                        <img src="/assets/images/ecallAssistant_icon/Icon-10.png" alt="Location" style="width:12px; height:12px; margin-right:4px; vertical-align:middle;">
                        <strong>${incident.address}</strong>
                    </div>
                    <div style="margin-bottom:4px;"><strong>Status:</strong> <span class="incident-status ${incident.statusClass}">${incident.status}</span></div>
                    <div><strong>Agent:</strong> ${incident.agent.name}</div>
                </div>`;
            
            const styledContent = `
                <style>
                    .category-badge { padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; color: white; }
                    .category-disaster { background-color: #f59e0b; } .category-medical { background-color: #10b981; }
                    .category-crime { background-color: #3b82f6; } .category-traffic { background-color: #facc15; color: #1d1d1f; }
                    .category-rescue { background-color: #8b5cf6; } .category-other { background-color: #6b7280; }
                    .urgency-level { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; }
                    .urgency-1 { background-color: #374151; color: white; } .urgency-2 { background-color: #6b7280; color: white; }
                    .urgency-3 { background-color: #9ca3af; color: white; } .urgency-4 { background-color: #d1d5db; color: #1f2937; }
                    .urgency-5 { background-color: #e5e7eb; color: #1f2937; }
                    .incident-status { font-weight: 600; }
                    .status-handling { color: #f59e0b; } .status-assigned { color: #3b82f6; }
                    .status-on-scene { color: #8b5cf6; } .status-closed { color: #10b981; }
                </style>
                ${content}`;

            infowindow.setContent(styledContent);
            infowindow.open(map, marker);
        }

        function filterMapMarkers(category) {
            infowindow.close();
            markers.forEach(marker => {
                if (category === 'All' || marker.incident.category === category) {
                    marker.setMap(map);
                } else {
                    marker.setMap(null);
                }
            });
        }
    </script>
</body>
</html>
